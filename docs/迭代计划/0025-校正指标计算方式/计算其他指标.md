# 指标正确性分析与测试补充

---

## 1. 条件在险价值 CVaR (Conditional VaR / Expected Shortfall)

参考：https://en.wikipedia.org/wiki/Expected_shortfall

### Wikipedia / 学术定义

Expected Shortfall (ES)，也称 Conditional VaR (CVaR)，是一种一致性风险度量（coherent risk measure）。

**连续分布定义：**

```
ES_α = -1/α × ∫_0^α VaR_γ(X) dγ
```

**历史模拟法（离散）定义：**

```
ES_α = E[R | R ≤ VaR_α] = mean(r_i | r_i ≤ quantile(returns, α))
```

即：取所有收益率中低于或等于 VaR 阈值的收益率的平均值。

关键要点：
- CVaR 衡量的是**超过 VaR 阈值后的预期损失**
- CVaR ≤ VaR（因为它是更极端尾部的平均值）
- CVaR 是一致性风险度量（满足次可加性），VaR 不是

### fincore 实现 (`fincore/metrics/risk.py:183-205`)

```python
def conditional_value_at_risk(returns, cutoff=0.05):
    if len(returns) < 1:
        return np.nan
    cutoff_index = value_at_risk(returns, cutoff=cutoff)  # percentile(returns, cutoff*100)
    return np.mean(returns[returns <= cutoff_index])
```

### 分析

| 项目 | Wikipedia（历史模拟法） | fincore | 是否一致 |
|------|------------------------|---------|---------|
| 方法 | 取 ≤ VaR 的收益率平均值 | `mean(returns[returns <= VaR])` | ✅ |
| VaR 阈值 | α 百分位数 | `percentile(returns, cutoff×100)` | ✅ |
| 符号惯例 | 返回收益率值（通常为负） | 返回收益率值（通常为负） | ✅ |

### 结论：✅ 正确

fincore 的 `conditional_value_at_risk` 采用历史模拟法，与 Wikipedia Expected Shortfall 的离散定义完全一致。

### 与第三方平台文档的差异分析

需求.md 中记录的差异：文档使用 `CVaR = mean(ri | ri < VaR) × sqrt(q)` 乘以了 `sqrt(q)` 进行年化/持有期调整。

- Wikipedia 的 ES 定义**不包含年化因子**
- `×sqrt(q)` 是第三方平台自行添加的持有期调整（基于方差-协方差法的假设：收益率独立同分布）
- fincore 不做此调整是**正确的**，与学术标准一致

### 测试情况：⚠️ 测试存在但不够充分

现有测试 `test_conditional_value_at_risk`（在 `test_stats.py:1150`）仅使用随机数据验证 `mean(returns[returns <= VaR])` 的一致性，缺少：
- 手算验证（确定性数据）
- 边界条件（空序列、单值）
- CVaR ≤ VaR 的一致性关系

**需要补充测试。** → 见 `tests/test_empyrical/test_other_indicators.py`

---

## 2. 条件夏普比率 (Conditional Sharpe Ratio)

参考：Chow, V. & Lai, C.W. (2014). "Conditional Sharpe Ratios." Finance Research Letters, 12, 117-133.
SSRN: https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2489764

### 学术定义

Chow & Lai (2014) 定义的 Conditional Sharpe Ratio (CSR) 是基于条件随机占优 (CSD) 的统计量，衡量资产在左尾分布中的风险调整超额收益：

```
CSR(q) = E[R - Rf | R ≤ F^{-1}(q)] / σ(R | R ≤ F^{-1}(q))
```

其中：
- `F^{-1}(q)` = 收益率分布的第 q 分位数
- 分子 = 左尾条件超额收益的均值
- 分母 = 左尾条件收益的标准差
- q 是截断概率（如 0.05 表示最差 5%）

核心思想：只看最差的 q% 收益率，计算这部分收益率的 Sharpe 比率。

### fincore 实现 (`fincore/metrics/ratios.py:270-315`)

```python
def conditional_sharpe_ratio(returns, cutoff=0.05, risk_free=0, period=DAILY, annualization=None):
    ann_factor = annualization_factor(period, annualization)

    cutoff_value = np.percentile(returns, cutoff * 100)
    conditional_returns = returns[returns <= cutoff_value]

    if len(conditional_returns) < 2:
        return np.nan

    mean_ret = np.mean(conditional_returns) - risk_free
    std_ret = np.std(conditional_returns, ddof=1)

    if std_ret == 0:
        return np.nan

    return mean_ret / std_ret * np.sqrt(ann_factor)
```

### 分析

| 项目 | Chow & Lai (2014) | fincore | 是否一致 |
|------|-------------------|---------|---------|
| 分位数截断 | F^{-1}(q) | `percentile(returns, cutoff×100)` | ✅ |
| 条件子集 | R ≤ F^{-1}(q) | `returns[returns <= cutoff_value]` | ✅ |
| 分子 | E[R - Rf \| 条件] | `mean(conditional_returns) - risk_free` | ✅ |
| 分母 | σ(R \| 条件) | `std(conditional_returns, ddof=1)` | ✅ |
| 年化 | 论文未指定 | `×sqrt(ann_factor)` | ✅ 标准扩展 |

### 结论：✅ 正确

fincore 的 `conditional_sharpe_ratio` 与 Chow & Lai (2014) 的 CSR 核心定义一致：
1. ✅ 使用分位数截断选取左尾子集
2. ✅ 在条件子集上计算 (mean - rf) / std
3. ✅ 年化方式标准（×√q）

### 测试情况：✅ 已有充分测试

- `test_conditional_sharpe_ratio` — 基本计算验证（`test_special_indicators.py`）
- `test_conditional_sharpe_ratio_positive` — 正收益验证
- `test_conditional_sharpe_ratio_empty` — 空序列返回 NaN
- `test_conditional_sharpe_vs_regular_sharpe` — 与标准 Sharpe 符号一致
- `test_conditional_sharpe_custom_cutoff` — 自定义 cutoff
- `test_modified_ratios.py` 中还有 risk_free 参数相关测试

**无需额外新增测试。**

---

## 汇总

| 指标 | 正确性 | 是否需要修改 | 是否需要新增测试 |
|------|--------|-------------|-----------------|
| CVaR (Conditional VaR) | ✅ 正确 | 否 | **是**（补充手算+边界测试） |
| Conditional Sharpe Ratio | ✅ 正确 | 否 | 否（已有 7+ 个测试） |