# Phase 2: 代码风格统一

## 当前状态

pyproject.toml 中的 Ruff 配置：

```toml
[tool.ruff.lint]
select = ["E", "F", "I", "UP", "B", "SIM"]
ignore = [
    "E402",   # module-level import not at top of file
    "E501",   # line too long
    "F401",   # unused import (dynamic access via __getattr__)
    "UP007",  # use X | Y for union types
    "UP031",  # use format specifiers
    "UP035",  # import from typing
    "B007",   # unused loop variable
    "B023",   # function definition does not bind loop variable
    "B028",   # no explicit stacklevel
    "B904",   # raise without from inside except
    "SIM102", # collapsible if
    "SIM105", # use contextlib.suppress
    "SIM108", # use ternary operator
    "SIM113", # use enumerate
    "SIM118", # use key in dict
    "SIM201", # use != instead of not ==
]
```

## 改进计划

### 阶段 1: 可快速修复的规则

以下规则可以安全启用并自动修复：

| 规则 | 说明 | 行动 |
|------|------|------|
| B028 | 添加 stacklevel | 手动补充 |
| B904 | raise ... from e | 自动修复 |
| SIM102 | 可合并的 if | 自动修复 |
| SIM108 | 三元运算符 | 自动修复 |

### 阶段 2: 需要评估的规则

| 规则 | 说明 | 注意事项 |
|------|------|----------|
| UP007 | `X \| Y` 联合类型 | 需要 Python 3.10+ |
| UP031 | format 字符串 | 可能影响性能 |
| SIM113 | enumerate | 可能降低可读性 |

### 阶段 3: 保持忽略的规则

这些规则因项目特性需要保持忽略：

| 规则 | 原因 |
|------|------|
| E402 | 懒加载架构需要延迟导入 |
| F401 | 动态 `__getattr__` 访问 |
| E501 | 由 ruff format 处理 |
| B007 | 循环变量有时有意不使用 |

## 中文注释转英文

### 优先级

1. **核心模块** (优先): `core/`, `metrics/`, `utils/`
2. **功能模块**: `risk/`, `optimization/`, `attribution/`
3. **辅助模块**: `data/`, `viz/`, `tearsheets/`

### Docstring 风格统一

采用 Google 风格：

```python
def calculate_metric(returns, factor_returns=None):
    """Calculate a financial metric.

    This function computes the metric for the given returns.
    If factor_returns is provided, benchmark-relative metrics
    are also calculated.

    Args:
        returns (pd.Series or np.ndarray): Asset returns.
        factor_returns (pd.Series or np.ndarray, optional):
            Benchmark returns. Defaults to None.

    Returns:
        float: The calculated metric value.

    Raises:
        ValueError: If inputs are invalid.

    Examples:
        >>> import fincore
        >>> returns = pd.Series([0.01, 0.02, -0.01])
        >>> fincore.sharpe_ratio(returns)
        0.523
    """
```

## 执行步骤

```bash
# 1. 启用更多规则并自动修复
ruff check fincore/ --select B904,SIM102,SIM108 --fix

# 2. 格式化代码
ruff format fincore/

# 3. 验证
ruff check fincore/ tests/
```

## 验收标准

- Ruff ignore 列表减少至 10 条以内
- 所有公开 API 有 Google 风格 docstring
- 所有注释使用英文
