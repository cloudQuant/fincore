### 背景
docs/0025-校正指标计算方式/指标算法帮助文档.docx  这个文档里面是一些第三方平台的指标的计算方式

### 任务
1. 希望你能从这个指标算法帮助文档.docx里面提取出这些指标的计算方式
2. 从当前项目中获取相应指标的计算方式
3. 对比现在项目中的指标的计算方式和指标算法帮助文档里面的计算方式有什么区别
4. 如果有区别，把有区别的指标，以及差异的地方放到这个文档的下面。

---

## 对比结果

### 全局差异

| 项目 | 文档（第三方平台） | fincore |
|------|-------------------|---------|
| **日频年化因子 q** | 250 | 252 (`APPROX_BDAYS_PER_YEAR`) |
| **周/月/季频年化因子** | 52 / 12 / 4 | 52 / 12 / 4（一致） |
| **无风险利率默认值** | 3%（0.03） | 0（`risk_free=0`） |
| **年化收益计算** | CAGR: `∏(1+ri)^(q/T) - 1` | CAGR: `cum_returns_final^(1/num_years) - 1`，其中 `num_years = T / ann_factor`，数学上等价 |

> **影响范围**：日频年化因子 250 vs 252 会影响所有涉及年化的指标。无风险利率默认值 3% vs 0 会影响夏普、索提诺、卡玛、特雷诺等所有使用 rf 的指标。

---

### 有差异的指标详情

#### 1. 夏普比率 (Sharpe Ratio)

- **文档**：`SR = (r_annual - rf) / σ`
  - 分子：CAGR（复合年化收益）减去无风险利率
  - 分母：`σ = sqrt(q × Σ(ri - r̄)² / (T-1))`，收益率序列的年化标准差
- **fincore** (`fincore/metrics/ratios.py:52`)：`SR = mean(ri - rf) / std(ri - rf, ddof=1) × sqrt(q)`
  - 分子：日超额收益均值 × sqrt(年化因子)
  - 分母：日超额收益标准差（ddof=1）
- **差异**：
  - **分子不同**：文档用 CAGR - rf（几何年化），fincore 用 mean_excess × sqrt(q)（算术年化）
  - 当收益率较小时两者接近，但在高收益率或高波动率情况下会有显著差异

#### 2. 索提诺比率 (Sortino Ratio)

- **文档**：
  - `LPM2(rf) = 1/(T-1) × Σ max(0, rf - ri)²`
  - `Sortino = (r_annual - rf) / sqrt(q × 2 × LPM2(rf))`
- **fincore** (`fincore/metrics/ratios.py:106`)：
  - `downside_diff = clip(ri - required_return, -inf, 0)`（所有期数）
  - `downside_risk = sqrt(mean(downside_diff²)) × sqrt(q)`（使用 1/T，不是 1/(T-1)）
  - `Sortino = mean(ri - req) × q / downside_risk`
- **差异**：
  - **分子**：文档用 CAGR - rf，fincore 用 mean_excess × ann_factor
  - **分母 LPM 计算**：文档用 1/(T-1)，fincore 用 1/T（mean）
  - **分母额外因子**：文档有 `×2` 因子，fincore 没有
  - **默认阈值**：文档用 rf（无风险利率），fincore 用 required_return（默认0）

#### 3. 调整夏普比率 (Adjusted Sharpe Ratio)

- **文档**：`Adj_SR = (r_annual_P - r_annual_B) / σ_P`
  - 年化主动收益（相对基准）除以组合年化风险
- **fincore** (`fincore/metrics/ratios.py:217`)：
  - 对标准夏普比率做偏度/峰度校正（Pézier & White 方法）
  - `adj_sharpe = sharpe × (1 + skew/6 × sharpe - kurt/24 × sharpe²)`
- **差异**：**完全不同的指标定义**
  - 文档：超额收益（相对基准）/组合波动率
  - fincore：标准夏普比率的非正态分布校正版本

#### 4. 卡玛比率 (Calmar Ratio)

- **文档**：`Calmar = (r_annual - rf) / MD1`
- **fincore** (`fincore/metrics/ratios.py:316`)：`Calmar = annual_return / abs(max_drawdown)`
- **差异**：**文档分子减去了 rf**，fincore 没有减去无风险利率

#### 5. 下行风险 (Downside Risk)

- **文档**：
  - 仅使用 ri < 0 的期数（Td = 负收益期数）
  - `r̄ = mean(ri | ri < 0)`（负收益的均值）
  - `DR = sqrt(q × Σ(ri - r̄)² / (Td-1))`，仅对负收益计算标准差
- **fincore** (`fincore/metrics/risk.py:97`)：
  - 使用**所有期数**：`clip(ri - required_return, -inf, 0)`
  - 正收益贡献0，负超额收益贡献其值的平方
  - `DR = sqrt(mean(downside_diff²)) × sqrt(q)`
- **差异**：
  - **计算范围**：文档仅用负收益期数，fincore 用所有期数（正收益贡献0）
  - **中心化**：文档相对负收益均值做偏差，fincore 相对阈值做偏差
  - **自由度**：文档用 Td-1，fincore 用 T（mean）
  - 这是两种不同的下行风险定义

#### 6. 信息比率 (Information Ratio)

- **文档**：
  - `IR = (r_annual_P - r_annual_B) / σ_A`
  - 分子：CAGR(组合) - CAGR(基准)（各自独立计算 CAGR 后相减）
  - 分母：`σ_A = sqrt(q × Σ(ri_A - mean(ri_A))² / (T-1))`
- **fincore** (`fincore/metrics/ratios.py:401`)：
  - `active = ri_P - ri_B`（每日主动收益）
  - `IR = mean(active) × ann_factor / (std(active, ddof=1) × sqrt(ann_factor))`
  - 简化为：`IR = mean(active) × sqrt(ann_factor) / std(active, ddof=1)`
- **差异**：
  - **分子**：文档用两个 CAGR 之差，fincore 用算术平均主动收益 × ann_factor

#### 7. 残差风险 (Residual Risk)

- **文档**：`res_risk = sqrt(q × Σεi² / (T-2))`（T-2 个自由度，回归消耗2个参数）
- **fincore** (`fincore/metrics/risk.py:291`)：`std(residuals, ddof=1) × sqrt(ann_factor)`（使用 ddof=1，即 T-1）
- **差异**：**自由度不同**：文档用 T-2（更严格，因为回归估计了α和β），fincore 用 T-1

#### 8. 在险价值 VaR (Value at Risk)

- **文档**：`VaR(Δt, α) = quantile(r1,...,rn, α) × sqrt(Δt)`
  - 乘以持有期 Δt 的平方根
- **fincore** (`fincore/metrics/risk.py:158`)：`VaR = percentile(returns, cutoff × 100)`
  - 直接取历史分位数，不做持有期调整
- **差异**：**文档乘以 sqrt(Δt)**，fincore 无持有期缩放

#### 9. 条件在险价值 CVaR (Conditional VaR)

- **文档**：`CVaR = mean(ri | ri < VaR) × sqrt(q)`
- **fincore** (`fincore/metrics/risk.py:183`)：`CVaR = mean(returns[returns <= VaR])`
- **差异**：**文档乘以 sqrt(q) 做年化**，fincore 不做年化处理

#### 10. VaR 超额收益

- **文档**：`ER-VaR = (r_annual - rf) / VaR`（年化收益减 rf 除以 VaR）
- **fincore** (`fincore/metrics/risk.py:336`)：`var_excess_return = mean(returns[returns <= VaR])`（VaR 尾部的平均收益）
- **差异**：**完全不同的指标定义**
  - 文档：年化超额收益与 VaR 的比值
  - fincore：VaR 尾部的平均收益

#### 11. 条件夏普比率 (Conditional Sharpe Ratio)

- **文档**：`CSR = (r_annual - rf) / CVaR`
- **fincore** (`fincore/metrics/ratios.py:270`)：对左尾收益子集计算标准夏普比率
  - `CSR = mean(conditional_returns) / std(conditional_returns, ddof=1) × sqrt(q)`
- **差异**：
  - 文档：年化收益减 rf 除以 CVaR
  - fincore：对尾部收益子集单独计算夏普比率



#### 13. 赫斯特指数 (Hurst Exponent)

- **文档**：
  - 按 `min(int(log2(N)), 8)` 种规格分割
  - 使用 `log2` 做回归
- **fincore** (`fincore/metrics/stats.py:89`)：
  - lag 范围：2 到 n//3，最多30个点（使用 geomspace）
  - 使用自然对数 `ln` 做回归
- **差异**：
  - 分割策略不同（文档最多8种，fincore最多30种）
  - 对数底数不同（log2 vs ln），但回归斜率结果相同（因为 log 底数变换只影响截距）

#### 14. STUTZER 指数

- **文档**：
  - `IP = max[-log(1/T × Σ exp(θ×ri))]`
  - `Stutzer = |r̄|/r̄ × sqrt(2×IP)`（带符号调整）
- **fincore** (`fincore/metrics/stats.py:188`)：
  - 用 scipy 优化求解 `max[-log(mean(exp(θ×ri))) / θ]`
  - 直接返回优化结果
- **差异**：
  - 文档有 `|r̄|/r̄ × sqrt(2×IP)` 的符号和缩放处理
  - fincore 直接返回优化目标值，缺少符号和 sqrt(2) 缩放

#### 15. Omega 比率 (Omega Ratio)

- **文档**：`Ω = UPM1(rh) / LPM1(rh)`，其中 rh 为最小可接受收益率（约定为无风险利率）
  - `UPM1 = 1/(T-1) × Σ max(0, ri - rh/q)`
  - `LPM1 = 1/(T-1) × Σ max(0, rh/q - ri)`
- **fincore** (`fincore/metrics/ratios.py:355`)：
  - `return_threshold = (1 + required_return)^(1/annualization) - 1`
  - `omega = sum(positive) / sum(negative)`（不做 1/(T-1) 归一化，但在比值中可消除）
- **差异**：
  - 阈值去年化方式不同：文档用 `rh/q`（简单除法），fincore 用 `(1+rh)^(1/q) - 1`（复合去年化）
  - fincore 额外减去了 risk_free

#### 16. Kappa3 比率

- **文档**：
  - `LPM3 = 1/(T-1) × Σ max(0, rh/q - ri)³`
  - `Kappa3 = (r_annual - rh) / ∛(LPM3 × q)`
- **fincore** (`fincore/metrics/ratios.py:726`)：
  - `lpm3 = mean(max(0, mar - ri)³)`（使用 1/T，不是 1/(T-1)）
  - `Kappa3 = (ann_ret - risk_free) / (lpm3 × ann_factor)^(1/3)`
- **差异**：
  - LPM 分母：文档 T-1，fincore T
  - 默认阈值：文档用无风险利率，fincore `mar` 参数默认0

#### 17. H-M 模型（择时能力）

- **文档**：`ri_P = a + b×ri_B + γ×max(0, ri_B) + εi`（原始收益率）
- **fincore** (`fincore/metrics/timing.py:76`)：
  - 使用超额收益（减去 rf）
  - 虚拟变量：`down_market = (excess_factor < 0)`
  - 回归：`excess_returns ~ [1, excess_factor, down_market]`
- **差异**：
  - 文档用原始收益率和 max(0, ri_B)，fincore 用超额收益和下行虚拟变量
  - 数学上等价但参数解释可能不同

#### 18. T-M 模型（择时能力）

- **文档**：`ri_P = a + b×ri_B + γ×ri_B² + εi`（原始收益率）
- **fincore** (`fincore/metrics/timing.py:36`)：使用超额收益（减去 rf）
- **差异**：文档用原始收益率，fincore 用超额收益

#### 19. C-L 模型（择时能力）

- **文档**：`ri_P = a + b×min(0, ri_B) + c×max(0, ri_B) + εi`，择时能力 = c - b
- **fincore** (`fincore/metrics/timing.py:149`)：分别在上行和下行市场做回归得到 beta_up 和 beta_down，timing = beta_up - beta_down
- **差异**：文档用单一回归，fincore 分开做回归。数学上等价。

#### 20. R 平方

- **文档**：`R² = (β × σ_B / σ_P)²`（CAPM 回归拟合优度）
- **fincore**：无直接对应函数
  - `r_cubed` (`stats.py:444`) 计算的是 correlation³（不同指标）
  - `stability_of_timeseries` (`ratios.py:817`) 计算的是累积对数收益的线性拟合 R²
- **差异**：**fincore 缺少文档定义的 CAPM R² 指标**

---

### fincore 缺少的指标

以下指标在文档中有定义，但 fincore 中没有直接对应的实现：

| 文档指标 | 说明 |
|---------|------|
| **投资胜率（相对沪深300）** | fincore 有 `win_rate`（绝对胜率），但没有相对基准的胜率 |
| **MAR 比率** | 文档用算术平均年化收益/最大回撤，fincore 的 `calmar_ratio` 用 CAGR/最大回撤 |
| **回归年度回报率 RAR** | 净值对时间线性回归的斜率，fincore 未实现 |
| **R 立方（海龟指标）** | RAR / 平均最大年回撤幅度，fincore 的 `r_cubed` 是不同定义 |
| **R 平方（CAPM）** | (β × σ_B / σ_P)²，fincore 未实现此定义 |
| **上行/下行捕获收益** | fincore 仅有捕获率，没有单独的捕获收益指标 |
| **VaR 超额收益**（文档定义） | 文档为年化收益/VaR，fincore 的 `var_excess_return` 是尾部平均收益 |

---

### 一致（或基本一致）的指标

以下指标在两者之间基本一致（除全局年化因子250 vs 252差异外）：

- 累计收益、年化收益、年化主动收益
- 年化风险（年化标准差）
- 年化主动风险
- 跟踪误差
- 最大回撤及回撤天数/修复天数（含第二、三大回撤）
- 亏损天数占比 / 盈利天数占比
- 最大连续涨幅/跌幅、最大单日涨跌幅、连涨/连跌天数及日期
- 峰度、偏度
- 市场相关性（Pearson 相关系数）
- Alpha / Beta（CAPM 回归，方法等价）
- 特雷诺比率
- M 平方（数学上等价）
- Burke 比率
- 斯特林比率（思路一致，回撤序列获取方式略有差异）

---

### 差异汇总优先级

| 优先级 | 差异 | 影响面 |
|--------|------|--------|
| **高** | 日频年化因子 250 vs 252 | 所有年化指标 |
| **高** | 无风险利率默认值 3% vs 0 | 夏普、索提诺、卡玛、特雷诺等 |
| **高** | 夏普比率分子：CAGR vs 算术年化 | 夏普比率、信息比率 |
| **高** | 下行风险计算方式完全不同 | 索提诺比率 |
| **高** | VaR/CVaR 缺少年化/持有期调整 | VaR、CVaR、条件夏普比率 |
| **中** | 调整夏普比率定义完全不同 | 调整夏普比率 |
| **中** | 残差风险自由度 T-2 vs T-1 | 残差风险 |
| **中** | 捕获率上行条件 >= 0 vs > 0 | 上行捕获率 |
| **中** | STUTZER 指数缺少符号和 sqrt(2) 缩放 | STUTZER 指数 |
| **低** | 卡玛比率是否减 rf | 卡玛比率 |
| **低** | Kappa3/Omega 阈值处理细节 | Kappa3、Omega |
| **低** | 择时模型原始收益 vs 超额收益 | C-L、H-M、T-M 模型 |