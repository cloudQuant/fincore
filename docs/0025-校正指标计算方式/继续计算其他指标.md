# 指标正确性分析与修改记录

---

## 1. VaR 超额收益 (var_excess_return)

### 文档定义

```
ER-VaR = (r_annual - rf) / |VaR|
```

年化超额收益与 VaR 的比值，衡量每承受一单位 VaR 风险可以获得多少超额回报。

### 修改前的 fincore 实现 (`fincore/metrics/risk.py:336`)

```python
def var_excess_return(returns, cutoff=0.05):
    var_value = value_at_risk(returns, cutoff)
    excess_returns = returns[returns <= var_value]
    return np.mean(excess_returns)
```

**问题**：这是 `mean(returns[returns <= VaR])`，即 VaR 尾部的平均收益，与 `conditional_value_at_risk` 完全重复。与文档定义完全不同。

### 修改后的实现

```python
def var_excess_return(returns, cutoff=0.05, risk_free=0.0, period=DAILY, annualization=None):
    ann_ret = annual_return(returns, period=period, annualization=annualization)
    var_value = value_at_risk(returns, cutoff=cutoff)
    return (ann_ret - risk_free) / abs(var_value)
```

修改内容：
1. ✅ 分子改为 `annual_return - risk_free`（CAGR 减无风险利率）
2. ✅ 分母改为 `abs(VaR)`
3. ✅ 新增 `risk_free`、`period`、`annualization` 参数
4. ✅ 处理 VaR=0 和 NaN 边界条件
5. ✅ 同步更新 `Empyrical` 类的方法签名

### 测试：✅ 已添加 6 个测试

见 `tests/test_empyrical/test_continued_indicators.py::TestVarExcessReturn`

---

## 2. STUTZER 指数 (stutzer_index)

参考：
- Stutzer, M. (2000). "A Portfolio Performance Index." Financial Analysts Journal, 56(3), 52-61.
- https://breakingdownfinance.com/finance-topics/performance-measurement/stutzer-index/
- https://zhuanlan.zhihu.com/p/576492259

### 标准公式

```
I_P = max_θ { -log(1/T × Σ exp(θ × r_t)) }
   = max_θ { -log(mean(exp(θ × r_t))) }

Stutzer = (|r̄| / r̄) × sqrt(2 × I_P)
```

其中：
- r_t = 超额收益
- r̄ = 平均超额收益
- θ 的最优值：当 r̄ > 0 时，θ* < 0；当 r̄ < 0 时，θ* > 0
- `|r̄|/r̄` 是符号函数，确保正超额收益→正指数，负超额收益→负指数
- 当收益率正态分布时，Stutzer 指数 ≈ Sharpe 比率

### 修改前的 fincore 实现

```python
def neg_log_likelihood(theta):
    if theta <= 0:
        return np.inf
    return -np.log(exp_theta_r.mean()) / theta  # 除以了 theta！

result = minimize_scalar(neg_log_likelihood, bounds=(1e-10, 10), method="bounded")
return -result.fun  # 直接返回，无 sqrt(2) 和符号调整
```

**问题**：
1. ❌ **目标函数错误**：除以了 θ，标准公式不除以 θ
2. ❌ **缺少 sqrt(2) 缩放**：直接返回优化结果而非 `sqrt(2 × I_P)`
3. ❌ **缺少符号调整**：没有 `|r̄|/r̄` 的符号因子
4. ❌ **θ 范围错误**：限制 θ > 0，但当 r̄ > 0 时最优 θ 应为负数

### 修改后的实现

```python
def neg_ip(theta):
    exp_theta_r = np.exp(theta * excess_returns)
    log_mean = np.log(exp_theta_r.mean())
    return log_mean  # minimize log(mean(exp(θr))) = maximize -log(mean(exp(θr)))

if mean_excess > 0:
    result = minimize_scalar(neg_ip, bounds=(-50, -1e-10), method="bounded")
else:
    result = minimize_scalar(neg_ip, bounds=(1e-10, 50), method="bounded")

ip = -result.fun
sign = 1.0 if mean_excess > 0 else -1.0
return sign * np.sqrt(2 * ip)
```

修改内容：
1. ✅ 目标函数去掉除以 θ
2. ✅ 添加 `sqrt(2 × I_P)` 缩放
3. ✅ 添加 `sign = |r̄|/r̄` 符号调整
4. ✅ θ 范围根据 r̄ 的符号选择（r̄ > 0 时 θ < 0，r̄ < 0 时 θ > 0）
5. ✅ 处理零均值边界条件

### 测试：✅ 已添加 8 个测试

见 `tests/test_empyrical/test_continued_indicators.py::TestStutzerIndex`

关键测试：
- `test_normal_returns_approx_sharpe` — 验证正态分布下 Stutzer ≈ Sharpe
- `test_skewed_returns_penalized` — 验证负偏分布被惩罚（Stutzer 更低）

---

## 3. fincore 缺少或定义不同的指标分析

以下指标在文档中有定义，但 fincore 中缺少或定义不同。**这些不属于"计算错误"，而是功能缺失或设计差异。**

### 3.1 投资胜率（相对基准）

- **文档**：相对沪深300的胜率 = 策略日收益 > 基准日收益的天数占比
- **fincore**：`win_rate` 计算绝对胜率（日收益 > 0 的占比）
- **现状**：功能缺失
- **建议**：可在 `stats.py` 中添加 `relative_win_rate(returns, factor_returns)` 函数，计算 `sum(returns > factor_returns) / T`

### 3.2 MAR 比率

- **文档**：`MAR = 算术平均年化收益 / |最大回撤|`
- **fincore**：`calmar_ratio` 使用 `CAGR / |max_drawdown|`
- **差异**：分子不同（算术平均年化 vs CAGR）
- **分析**：Calmar Ratio 的标准定义确实使用 CAGR，而 MAR Ratio 是另一个指标。fincore 的 `calmar_ratio` 是正确的。MAR 比率是一个独立的指标，需要单独实现。
- **建议**：如需支持，可新增 `mar_ratio` 函数

### 3.3 回归年度回报率 RAR

- **文档**：净值对时间序列做线性回归，斜率即为 RAR
- **fincore**：`regression_annual_return` 计算的是 `alpha + beta × benchmark_annual_return`（CAPM 回归年化收益）
- **差异**：完全不同的定义。文档的 RAR 是净值-时间回归斜率，fincore 是 CAPM 分解。
- **分析**：fincore 的 `regression_annual_return` 名称有歧义。它实际是 CAPM 预期收益的分解，不是文档中的"回归年度回报率"。
- **建议**：如需文档版 RAR，需新增函数实现净值对时间的线性回归

### 3.4 R 立方（海龟指标）

- **文档**：`R³ = RAR / 平均最大年回撤幅度`
- **fincore**：`r_cubed` 计算的是 `correlation(returns, benchmark)³`
- **差异**：完全不同的定义
- **分析**：fincore 的 `r_cubed` 是统计学的相关系数立方，文档的 R³ 是海龟交易法则中的风险调整收益指标。两者名称相同但含义不同。
- **建议**：这是两个不同指标。如需文档版 R³，需先实现 RAR，然后新增文档版的 R³ 函数

### 3.5 R 平方（CAPM）

- **文档**：`R² = (β × σ_B / σ_P)²`
- **fincore**：`stability_of_timeseries` 计算的是累积对数收益的线性拟合 R²（不同指标）
- **差异**：fincore 缺少文档定义的 CAPM R² 指标
- **分析**：文档的 R² 是 CAPM 模型的决定系数，衡量系统性风险解释的收益占比
- **建议**：可新增 `capm_r_squared(returns, factor_returns)` 函数

### 3.6 上行/下行捕获收益

- **文档**：上行/下行捕获收益（具体收益值）
- **fincore**：`up_capture` / `down_capture` / `up_down_capture` 计算的是捕获**率**（比率）
- **差异**：fincore 有捕获率但没有单独的捕获收益指标
- **分析**：捕获率已覆盖核心需求。捕获收益是更细粒度的指标
- **建议**：优先级较低，可按需添加

---

## 汇总

| 指标 | 操作 | 状态 |
|------|------|------|
| **VaR 超额收益** | 修改实现为 `(ann_ret - rf) / abs(VaR)` | ✅ 已修改 + 6 个测试 |
| **STUTZER 指数** | 修复公式：添加 sqrt(2)、符号调整、修正 θ 范围 | ✅ 已修改 + 8 个测试 |
| **投资胜率（相对）** | 新增 `relative_win_rate(returns, factor_returns)` | ✅ 已实现 + 6 个测试 |
| **MAR 比率** | 新增 `mar_ratio(returns, period, annualization)` | ✅ 已实现 + 5 个测试 |
| **R 立方（海龟指标）** | 新增 `r_cubed_turtle(returns, period, annualization)`（含 RAR 计算） | ✅ 已实现 + 3 个测试 |
| **R 平方（CAPM）** | 新增 `capm_r_squared(returns, factor_returns)` | ✅ 已实现 + 5 个测试 |
| **上行/下行捕获收益** | 新增 `up_capture_return` / `down_capture_return` | ✅ 已实现 + 5 个测试 |

### 新增函数位置

| 函数 | 文件 |
|------|------|
| `relative_win_rate` | `fincore/metrics/stats.py` |
| `r_cubed_turtle` | `fincore/metrics/stats.py` |
| `capm_r_squared` | `fincore/metrics/stats.py` |
| `mar_ratio` | `fincore/metrics/ratios.py` |
| `up_capture_return` | `fincore/metrics/ratios.py` |
| `down_capture_return` | `fincore/metrics/ratios.py` |

所有函数已在 `_registry.py` 注册，并在 `Empyrical` 类中添加了 `@_dual_method` 包装。

测试文件：`tests/test_empyrical/test_new_indicators.py`（24 个测试）
