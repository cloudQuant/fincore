# 常见工作流

## 工作流 1：策略绩效快速评估

最常见的场景：拿到策略收益率后，快速评估策略质量。

```python
import fincore
from fincore import Empyrical

# 假设 returns 已准备好
# 1. 核心指标一览
stats = Empyrical.perf_stats(returns)
print(stats)

# 2. 按年分解
import pandas as pd
yearly = pd.DataFrame({
    "年化收益": Empyrical.annual_return_by_year(returns),
    "夏普比率": Empyrical.sharpe_ratio_by_year(returns),
    "最大回撤": Empyrical.max_drawdown_by_year(returns),
})
print(yearly)

# 3. 回撤分析
dd_table = Empyrical.gen_drawdown_table(returns, top=5)
print(dd_table)
```

## 工作流 2：生成策略报告

一行代码生成完整 HTML 或 PDF 报告：

```python
# 仅收益率 -> 基础报告
fincore.create_strategy_report(returns, title="My Strategy", output="report.html")

# 加上持仓 + 交易 -> 完整报告
fincore.create_strategy_report(
    returns,
    positions=positions,
    transactions=transactions,
    title="My Strategy — Full Report",
    output="full_report.html",
)

# PDF 输出
fincore.create_strategy_report(returns, title="My Strategy", output="report.pdf")
```

## 工作流 3：多策略对比

```python
from fincore import Empyrical

strategies = {
    "Strategy A": returns_a,
    "Strategy B": returns_b,
    "Strategy C": returns_c,
}

import pandas as pd
comparison = pd.DataFrame({
    name: {
        "Annual Return": Empyrical.annual_return(r),
        "Sharpe Ratio": Empyrical.sharpe_ratio(r),
        "Max Drawdown": Empyrical.max_drawdown(r),
        "Sortino Ratio": Empyrical.sortino_ratio(r),
        "Calmar Ratio": Empyrical.calmar_ratio(r),
        "Win Rate": Empyrical.win_rate(r),
    }
    for name, r in strategies.items()
})
print(comparison.T)
```

## 工作流 4：风险管理

```python
from fincore import Empyrical
from fincore.risk import evt_var, evt_cvar, GARCH, forecast_volatility

# 基础风险指标
print(f"VaR(95%):     {Empyrical.value_at_risk(returns, cutoff=0.05):.4f}")
print(f"CVaR(95%):    {Empyrical.conditional_value_at_risk(returns):.4f}")
print(f"下行风险:     {Empyrical.downside_risk(returns):.4f}")

# EVT 尾部风险
print(f"EVT VaR(99%): {evt_var(returns, alpha=0.01):.4f}")
print(f"EVT CVaR(99%):{evt_cvar(returns, alpha=0.01):.4f}")

# GARCH 波动率预测
garch = GARCH(returns)
vol_forecast = forecast_volatility(returns, horizon=5)
print(f"5日波动率预测: {vol_forecast}")
```

## 工作流 5：组合优化

```python
from fincore.optimization import efficient_frontier, risk_parity, optimize

# 多资产收益率 DataFrame
# returns_multi: pd.DataFrame, columns=资产名称

# 有效前沿
ef = efficient_frontier(returns_multi, n_points=50)

# 风险平价
rp_weights = risk_parity(returns_multi)

# 最大夏普
result = optimize(returns_multi, objective="max_sharpe")
print(f"Weights: {result['weights']}")
print(f"Sharpe:  {result['sharpe']:.4f}")
```

## 工作流 6：蒙特卡洛压力测试

```python
from fincore.simulation import MonteCarlo, bootstrap_ci

# 路径模拟
mc = MonteCarlo.simulate(returns, n_paths=10000, horizon=252)
print(f"1年后净值中位数: {mc.median_terminal:.4f}")
print(f"VaR(95%): {mc.var(alpha=0.05):.4f}")

# Bootstrap 置信区间
from fincore import Empyrical
ci = bootstrap_ci(returns, func=Empyrical.sharpe_ratio, n_samples=10000, alpha=0.05)
print(f"夏普比率 95% CI: [{ci[0]:.4f}, {ci[1]:.4f}]")
```

## 工作流 7：绩效归因

```python
from fincore.attribution import brinson_attribution, style_analysis

# Brinson 归因（需要组合/基准的行业权重和收益）
result = brinson_attribution(
    portfolio_weights=port_weights,
    benchmark_weights=bench_weights,
    portfolio_returns=port_returns,
    benchmark_returns=bench_returns,
)
print(f"配置效应: {result['allocation']:.4f}")
print(f"选择效应: {result['selection']:.4f}")

# 风格分析
style_result = style_analysis(returns, factor_returns_df)
```

## 工作流 8：可视化

```python
from fincore import Pyfolio

pf = Pyfolio(returns=returns)

# 单个图表
pf.plot_rolling_returns(returns)
pf.plot_drawdown_underwater(returns)
pf.plot_monthly_returns_heatmap(returns)

# 完整 tear sheet
pf.create_returns_tear_sheet()
pf.create_full_tear_sheet()

# Viz 后端
from fincore.viz import get_backend
viz = get_backend("matplotlib")
viz.plot_returns(cum_returns)
viz.plot_drawdown(drawdown)
```
