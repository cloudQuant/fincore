# 核心概念

## 架构总览

```
fincore
├── fincore.sharpe_ratio()              # Flat API（函数式）
├── Empyrical.sharpe_ratio(returns)     # 类级别调用（100+指标）
├── emp.win_rate()                      # 实例调用（自动填充参数）
├── analyze(returns)                    # AnalysisContext（缓存分析）
├── Pyfolio(returns).create_*()         # 可视化 tear sheet
├── create_strategy_report(returns)     # HTML/PDF 报告
├── fincore.risk                        # 高级风险模型（EVT, GARCH）
├── fincore.optimization                # 组合优化（有效前沿, 风险平价）
├── fincore.simulation                  # 蒙特卡洛模拟 & Bootstrap
└── fincore.attribution                 # 绩效归因（Brinson, 风格分析）
```

## 延迟加载机制

fincore 使用延迟加载（lazy import）优化启动速度：

- `import fincore` 仅需 ~0.05 秒
- 子模块在首次访问时才加载
- `Empyrical` 的 100+ 指标通过 `_LazyMethod` 描述符实现按需加载

```python
# 首次访问: 触发模块导入 + 缓存
sr = Empyrical.sharpe_ratio(returns)  # 导入 fincore.metrics.ratios

# 后续访问: 直接命中缓存，零开销
sr2 = Empyrical.sharpe_ratio(returns)
```

## Empyrical 类层次

```
Empyrical
├── 类方法 (100+): sharpe_ratio, max_drawdown, ...
│   └── 通过 _LazyMethod 描述符延迟加载
├── 实例方法 (@_dual_method): win_rate, treynor_ratio, ...
│   └── 自动从实例获取 returns / factor_returns
└── Pyfolio (继承自 Empyrical)
    ├── create_returns_tear_sheet()
    ├── create_full_tear_sheet()
    ├── plot_rolling_returns()
    └── ... (所有 plot_* 方法)
```

## AnalysisContext

`AnalysisContext` 使用 `cached_property` 实现惰性求值：

```python
ctx = fincore.analyze(returns)

# 第一次访问: 计算并缓存
ctx.sharpe_ratio  # 计算 sharpe_ratio

# 第二次访问: 直接返回缓存值
ctx.sharpe_ratio  # 零开销

# 清除缓存（数据变更后）
ctx.invalidate()
```

支持的输出格式：

| 方法 | 输出 |
|------|------|
| `ctx.perf_stats()` | `pd.Series` 性能指标摘要 |
| `ctx.to_dict()` | Python dict |
| `ctx.to_json()` | JSON 字符串 |
| `ctx.to_html()` | HTML 报告 |
| `ctx.plot()` | matplotlib 图表 |

## 注册表机制

`fincore/_registry.py` 定义了指标注册表 `CLASSMETHOD_REGISTRY`，将方法名映射到底层模块：

```python
CLASSMETHOD_REGISTRY = {
    "sharpe_ratio": ("fincore.metrics.ratios", "sharpe_ratio"),
    "max_drawdown": ("fincore.metrics.drawdown", "max_drawdown"),
    # ... 100+ entries
}
```

`@_populate_from_registry` 装饰器在类定义时遍历注册表，为每个条目设置 `_LazyMethod` 描述符。
