# 0028 任务分解

## 任务列表

### Task 1: 修复 plugin/__init__.py 语法错误

**文件**: `fincore/plugin/__init__.py:171`

**当前代码**:
```python
def list_hooks(event: Optional[str] = None) -> Dict[str, List[Callable]]:
    """List all registered hooks for an event.

    Parameters
    ----------
    event : str, optional
        Filter by event name. If None, returns all hooks.
    """
    if event is None:
        return {k: v for k, v in _HOOK_REGISTRY.items() for v}  # ❌ 错误
    return {event: _HOOK_REGISTRY.get(event, [])}
```

**修复后**:
```python
def list_hooks(event: Optional[str] = None) -> Dict[str, List[Callable]]:
    """List all registered hooks for an event.

    Parameters
    ----------
    event : str, optional
        Filter by event name. If None, returns all hooks.
    """
    if event is None:
        return _HOOK_REGISTRY.copy()  # ✅ 简单直接
    return {event: _HOOK_REGISTRY.get(event, [])}
```

**验收**: `python3 -c "from fincore.plugin import list_hooks; print(list_hooks())"` 成功运行

---

### Task 2: 修复 plugin/registry.py 类型注解

**文件**: `fincore/plugin/registry.py:106`

**当前代码**:
```python
def create_instance(cls, theme: str = "light") -> "MyBackend":
    return cls(theme=theme)
```

**修复后**:
```python
def create_instance(cls, theme: str = "light") -> Any:
    return cls(theme=theme)
```

**备注**: 这是一个示例函数，用于演示如何创建带主题的后端实例。返回类型应该是 `Any` 或具体类型。

---

### Task 3: 修复 Seaborn vert 参数弃用警告

**影响范围**: `fincore/tearsheets/` 中使用 seaborn boxplot 的地方

**需要修改的调用**:
```python
# 旧写法
sns.boxplot(x=col, y=data, vert=True, ax=ax)

# 新写法
sns.boxplot(x=col, y=data, orientation='vertical', ax=ax)
```

**搜索位置**:
```bash
grep -rn "vert=" fincore/tearsheets/
```

---

### Task 4: 抑制 EGARCH 数值警告

**文件**: `fincore/risk/garch.py` (Line 376-381)

**当前代码**:
```python
# 在 EGAR NEGARCH._loglike 中
eps_valid = y[1:] / np.sqrt(sigma2[1:])  # 可能除零
np.log(2 * np.pi * sigma2_valid)  # 可能 log(0)
eps_valid**2  # 可能溢出
```

**修复方案**: 使用 `np.errstate` 抑制警告
```python
with np.errstate(divide='ignore', invalid='ignore', over='ignore'):
    eps_valid = y[1:] / np.sqrt(sigma2[1:])
    log_lik = np.sum(
        np.log(2 * np.pi * sigma2_valid) +
        eps_valid**2 / sigma2_valid +
        2 * gamma * eps_valid / np.sqrt(sigma2_valid)
    )
```

---

### Task 5: 代码现代化 (Ruff auto-fix)

**运行命令**:
```bash
# 自动修复 UP006, UP045, I001 等警告
ruff check fincore/ --fix

# 格式化代码
ruff format fincore/

# 验证
ruff check fincore/
```

**预期修复**:
- `Dict` → `dict`
- `List` → `list`
- `Tuple` → `tuple`
- `Optional[X]` → `X | None`
- 导入顺序

---

## 优先级排序

| 任务 | 优先级 | 依赖 | 预计时间 |
|-----|--------|-----|---------|
| Task 1 | P0 | 无 | 5 min |
| Task 2 | P0 | 无 | 2 min |
| Task 3 | P1 | 无 | 5 min |
| Task 4 | P1 | 无 | 10 min |
| Task 5 | P1 | 无 | 10 min |

**总预计时间**: ~32 分钟
