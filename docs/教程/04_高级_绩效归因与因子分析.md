# 高级教程：绩效归因与因子分析

本教程介绍如何使用 fincore 的归因工具分解投资组合的收益来源。

## 前置知识

- 完成前序教程
- 了解 Alpha/Beta、因子模型的基本概念

## 核心问题

投资组合的超额收益从哪里来？

- **配置效应**: 资产配置贡献了多少？（选对了行业？）
- **选择效应**: 个股选择贡献了多少？（在行业内选对了股票？）
- **因子暴露**: 组合对哪些风险因子有暴露？（价值？动量？）

## 第 1 步：Brinson 归因

Brinson 模型将主动收益分解为配置效应和选择效应。

### 场景设定

假设你管理一个股票组合，投资于 5 个行业：

```python
import pandas as pd
from fincore.attribution import brinson_attribution, brinson_results

sectors = ["科技", "医疗", "金融", "能源", "消费"]

# 你的组合
port_weights = pd.Series([0.30, 0.20, 0.20, 0.15, 0.15], index=sectors)
port_returns = pd.Series([0.12, 0.08, 0.05, -0.03, 0.10], index=sectors)

# 基准（如沪深300的行业权重）
bench_weights = pd.Series([0.25, 0.20, 0.25, 0.15, 0.15], index=sectors)
bench_returns = pd.Series([0.10, 0.07, 0.06, -0.02, 0.08], index=sectors)
```

### 归因分解

```python
result = brinson_attribution(
    portfolio_weights=port_weights,
    benchmark_weights=bench_weights,
    portfolio_returns=port_returns,
    benchmark_returns=bench_returns,
)

print("=== Brinson 归因 ===")
print(f"配置效应:  {result['allocation']:.4f}")
print(f"选择效应:  {result['selection']:.4f}")
print(f"交互效应:  {result['interaction']:.4f}")
print(f"总主动收益:{result['total_active']:.4f}")
```

### 逐行业分解

```python
details = brinson_results(
    portfolio_weights=port_weights,
    benchmark_weights=bench_weights,
    portfolio_returns=port_returns,
    benchmark_returns=bench_returns,
)
print("\n逐行业归因:")
print(details)
```

### 解读

- **配置效应 > 0**: 你超配了表现好的行业（如超配科技）
- **选择效应 > 0**: 你在行业内选股能力强（如科技行业内收益 12% vs 基准 10%）
- **交互效应**: 配置和选择的联合效应

## 第 2 步：因子回归归因

使用回归模型分解收益的因子来源：

```python
import numpy as np

np.random.seed(42)
n_days = 500
dates = pd.date_range("2020-01-01", periods=n_days, freq="B")

# 组合收益
returns = pd.Series(np.random.normal(0.0005, 0.012, n_days), index=dates)

# 因子收益
factors = pd.DataFrame({
    "价值": np.random.normal(0.0002, 0.008, n_days),
    "成长": np.random.normal(0.0004, 0.01, n_days),
    "动量": np.random.normal(0.0003, 0.009, n_days),
    "质量": np.random.normal(0.0001, 0.006, n_days),
}, index=dates)

from fincore.attribution import calculate_regression_attribution

reg = calculate_regression_attribution(returns, factors)

print("=== 回归归因 ===")
print(f"Alpha (超额收益): {reg['alpha']:.6f}")
print(f"R² (解释力):      {reg['r_squared']:.4f}")
print(f"\n因子暴露 (Beta):")
for factor, beta in reg['betas'].items():
    print(f"  {factor:<8} β = {beta:.4f}")
```

### 解读

- **Alpha > 0**: 存在不能被因子解释的超额收益
- **R² 高**: 因子能很好地解释组合收益的变动
- **Beta 值**: 组合对各因子的敏感度

## 第 3 步：风格分析

Sharpe 风格分析使用**约束回归**（权重非负、和为 1），将组合视为因子的加权组合：

```python
from fincore.attribution import style_analysis, calculate_style_tilts

# 风格分析
style = style_analysis(returns, factors)
print("=== 风格分析 ===")
print(style)

# 风格倾斜
tilts = calculate_style_tilts(returns, factors)
print("\n风格倾斜:")
print(tilts)
```

### 风格分析 vs 回归归因

| 特性 | 风格分析 | 回归归因 |
|------|---------|---------|
| 约束 | 权重非负、和为 1 | 无约束 |
| 解释 | "组合像什么" | "组合对什么敏感" |
| Alpha | 通常较小（被约束吸收） | 真实的超额收益 |
| 适用 | 识别投资风格 | 量化因子暴露 |

## 第 4 步：Alpha/Beta 深度分析

使用 Empyrical 进行更细致的 Alpha/Beta 分析：

```python
from fincore import Empyrical

benchmark = pd.Series(np.random.normal(0.0003, 0.01, n_days), index=dates)

# 标准 Alpha/Beta
alpha, beta = Empyrical.alpha_beta(returns, benchmark)
print(f"Alpha: {alpha:.4f}, Beta: {beta:.4f}")

# 上行/下行 Alpha/Beta
up_a, up_b = Empyrical.up_alpha_beta(returns, benchmark)
down_a, down_b = Empyrical.down_alpha_beta(returns, benchmark)
print(f"上行 Alpha: {up_a:.4f}, Beta: {up_b:.4f}")
print(f"下行 Alpha: {down_a:.4f}, Beta: {down_b:.4f}")

# 捕获率
up_cap = Empyrical.up_capture(returns, benchmark)
down_cap = Empyrical.down_capture(returns, benchmark)
print(f"上行捕获率: {up_cap:.2%}")
print(f"下行捕获率: {down_cap:.2%}")
```

> **理想状态**: 上行 Beta > 1（牛市跑赢）+ 下行 Beta < 1（熊市防守好）

## 第 5 步：滚动因子暴露

```python
emp = Empyrical(returns=returns, factor_returns=benchmark)

# 63 天滚动窗口
rolling_alpha = emp.roll_alpha(window=63)
rolling_beta = emp.roll_beta(window=63)

print(f"滚动 Alpha 范围: [{rolling_alpha.min():.4f}, {rolling_alpha.max():.4f}]")
print(f"滚动 Beta 范围:  [{rolling_beta.min():.4f}, {rolling_beta.max():.4f}]")
```

> **用途**: 观察因子暴露是否稳定，或随市场环境变化

## 实践建议

1. **多角度验证**: 同时使用 Brinson、回归和风格分析，交叉验证结论
2. **样本期选择**: 归因结果对时间窗口敏感，建议用多个子期间分析
3. **因子选择**: 选择与策略逻辑相关的因子，避免数据挖掘
4. **稳定性**: 关注因子暴露的时间稳定性，不稳定的暴露可能是过拟合信号

## 小结

| 方法 | 输入 | 输出 | 最佳用途 |
|------|------|------|---------|
| Brinson | 行业权重+收益 | 配置/选择效应 | 行业配置能力评估 |
| 回归归因 | 因子收益 | Alpha + Beta | 因子暴露量化 |
| 风格分析 | 因子收益 | 风格权重 | 投资风格识别 |
| Alpha/Beta | 基准收益 | 上下行分析 | 牛熊市表现评估 |

## 完整示例

运行 `python examples/performance_attribution.py` 查看完整可运行示例。
