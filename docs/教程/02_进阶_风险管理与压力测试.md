# 进阶教程：风险管理与压力测试

本教程介绍如何使用 fincore 的高级风险模型对策略进行深度风险评估。

## 前置知识

- 完成 [入门教程](01_入门_策略绩效分析.md)
- 了解 VaR、CVaR 的基本概念

## 准备数据

```python
import numpy as np
import pandas as pd

np.random.seed(42)
dates = pd.date_range("2018-01-01", periods=1000, freq="B")

# 模拟带有肥尾特征的收益率
normal_rets = np.random.normal(0.0003, 0.01, 1000)
shock_mask = np.random.random(1000) < 0.05
shocks = np.random.normal(-0.02, 0.03, 1000)
returns = pd.Series(
    np.where(shock_mask, shocks, normal_rets),
    index=dates, name="strategy"
)
```

## 第 1 步：基础风险指标

```python
from fincore import Empyrical

print("=== 基础风险指标 ===")
print(f"年化波动率:   {Empyrical.annual_volatility(returns):.2%}")
print(f"下行风险:     {Empyrical.downside_risk(returns):.4f}")
print(f"VaR(95%):     {Empyrical.value_at_risk(returns, cutoff=0.05):.4f}")
print(f"CVaR(95%):    {Empyrical.conditional_value_at_risk(returns, cutoff=0.05):.4f}")
print(f"尾部比率:     {Empyrical.tail_ratio(returns):.4f}")
print(f"偏度:         {Empyrical.skewness(returns):.4f}")
print(f"峰度:         {Empyrical.kurtosis(returns):.4f}")
```

> **解读**: 高峰度 + 负偏度 = 收益分布有肥尾，且左尾更厚（极端亏损风险更大）

## 第 2 步：极值理论 (EVT) 尾部风险

标准 VaR 假设正态分布，低估尾部风险。EVT 直接建模尾部：

```python
from fincore.risk import hill_estimator, gpd_fit, evt_var, evt_cvar

# 尾部指数
tail_idx = hill_estimator(returns)
print(f"Hill 尾部指数: {tail_idx:.4f}")
# > 2: 肥尾（方差有限），< 2: 极端肥尾

# GPD 拟合
gpd = gpd_fit(returns)
print(f"GPD shape: {gpd['shape']:.4f}, scale: {gpd['scale']:.4f}")

# EVT-VaR vs 历史 VaR
hist_var = Empyrical.value_at_risk(returns, cutoff=0.01)
evt_var_99 = evt_var(returns, alpha=0.01)
print(f"\n99% VaR 对比:")
print(f"  历史 VaR: {hist_var:.4f}")
print(f"  EVT VaR:  {evt_var_99:.4f}")

# EVT-CVaR (Expected Shortfall)
print(f"  EVT CVaR: {evt_cvar(returns, alpha=0.01):.4f}")
```

> **要点**: EVT-VaR 通常比历史 VaR 更保守（数值更大），因为它考虑了尾部的极端事件

## 第 3 步：GARCH 条件波动率

波动率不是常数——GARCH 模型捕获波动率的时变特征：

```python
from fincore.risk import GARCH, EGARCH, forecast_volatility, conditional_var

# 标准 GARCH(1,1)
garch = GARCH(returns)
print("=== GARCH(1,1) ===")
print(f"参数: {garch.params}")

# 条件波动率序列
cond_vol = garch.conditional_volatility
print(f"\n最近 5 天条件波动率:")
print(cond_vol.tail())

# EGARCH (捕获杠杆效应)
egarch = EGARCH(returns)
print(f"\nEGARCH 参数: {egarch.params}")

# 波动率预测
vol_5d = forecast_volatility(returns, horizon=5)
print(f"\n未来 5 天波动率预测: {vol_5d}")

# GARCH 条件 VaR
garch_var = conditional_var(returns, alpha=0.05)
print(f"GARCH 条件 VaR(95%): {garch_var:.4f}")
```

> **应用**: 波动率突然升高时加大风控力度，波动率低时可适当放松

## 第 4 步：蒙特卡洛压力测试

模拟未来可能的路径，评估最坏情况：

```python
from fincore.simulation import MonteCarlo

mc = MonteCarlo.simulate(returns, n_paths=10000, horizon=252)

print("=== 蒙特卡洛模拟 (10000 路径, 1 年) ===")
terminal = mc.terminal_values
print(f"1 年后净值:")
print(f"  中位数:     {np.median(terminal):.4f}")
print(f"  5th 百分位: {np.percentile(terminal, 5):.4f}")
print(f"  95th 百分位:{np.percentile(terminal, 95):.4f}")
print(f"  亏损概率:   {(terminal < 1.0).mean():.1%}")

print(f"\n模拟风险指标:")
print(f"  VaR(95%):  {mc.var(alpha=0.05):.4f}")
print(f"  CVaR(95%): {mc.cvar(alpha=0.05):.4f}")
```

## 第 5 步：Bootstrap 置信区间

量化指标估计的不确定性：

```python
from fincore.simulation import bootstrap_ci

# 夏普比率的置信区间
ci_sr = bootstrap_ci(returns, func=Empyrical.sharpe_ratio, n_samples=5000, alpha=0.05)
print(f"夏普比率: {Empyrical.sharpe_ratio(returns):.4f}")
print(f"  95% CI: [{ci_sr[0]:.4f}, {ci_sr[1]:.4f}]")

# 最大回撤的置信区间
ci_dd = bootstrap_ci(returns, func=Empyrical.max_drawdown, n_samples=5000, alpha=0.05)
print(f"最大回撤: {Empyrical.max_drawdown(returns):.4f}")
print(f"  95% CI: [{ci_dd[0]:.4f}, {ci_dd[1]:.4f}]")
```

> **意义**: 如果夏普比率的 95% CI 包含 0，说明策略可能没有统计显著的超额收益

## 第 6 步：综合风险报告

```python
print("=" * 50)
print("综合风险评估报告")
print("=" * 50)

print(f"\n{'指标':<20} {'值':<15} {'方法'}")
print("-" * 50)
print(f"{'年化波动率':<20} {Empyrical.annual_volatility(returns):.4f}{'':>8} 标准")
print(f"{'历史 VaR(95%)':<20} {Empyrical.value_at_risk(returns):.4f}{'':>8} 经验分位数")
print(f"{'EVT VaR(95%)':<20} {evt_var(returns, alpha=0.05):.4f}{'':>8} 极值理论")
print(f"{'GARCH VaR(95%)':<20} {garch_var:.4f}{'':>8} 条件波动率")
print(f"{'MC VaR(95%)':<20} {mc.var(alpha=0.05):.4f}{'':>8} 蒙特卡洛模拟")
```

## 小结

| 方法 | 优势 | 局限 |
|------|------|------|
| 历史 VaR | 简单、非参数 | 依赖历史，低估尾部 |
| EVT | 专注尾部建模 | 需要足够的极端数据 |
| GARCH | 捕获波动率时变性 | 假设特定分布族 |
| 蒙特卡洛 | 灵活、可模拟复杂场景 | 依赖参数假设 |
| Bootstrap | 量化估计不确定性 | 假设独立同分布 |

## 下一步

- [进阶教程：组合优化](03_进阶_组合优化.md)
- 运行 `python examples/risk_models.py` 和 `python examples/monte_carlo_simulation.py`
