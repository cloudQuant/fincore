# 入门教程：策略绩效分析

本教程从零开始，展示如何使用 fincore 对一个策略进行全面的绩效分析。

## 第 1 步：准备数据

```python
import numpy as np
import pandas as pd

# 模拟一个策略的日收益率（实际使用时从回测日志或数据库读取）
np.random.seed(42)
dates = pd.date_range("2020-01-01", periods=750, freq="B", tz="UTC")
returns = pd.Series(np.random.normal(0.0004, 0.012, len(dates)), index=dates, name="strategy")
benchmark = pd.Series(np.random.normal(0.0003, 0.01, len(dates)), index=dates, name="benchmark")

print(f"策略数据: {len(returns)} 个交易日")
print(f"区间: {dates[0].strftime('%Y-%m-%d')} → {dates[-1].strftime('%Y-%m-%d')}")
```

## 第 2 步：快速查看核心指标

使用 Flat API 快速了解策略质量：

```python
import fincore

print(f"年化收益:   {fincore.annual_return(returns):.2%}")
print(f"年化波动率: {fincore.annual_volatility(returns):.2%}")
print(f"夏普比率:   {fincore.sharpe_ratio(returns):.4f}")
print(f"最大回撤:   {fincore.max_drawdown(returns):.2%}")
print(f"卡尔玛比率: {fincore.calmar_ratio(returns):.4f}")
print(f"索提诺比率: {fincore.sortino_ratio(returns):.4f}")
```

## 第 3 步：综合统计表

使用 Empyrical 一次性获取全部核心指标：

```python
from fincore import Empyrical

stats = Empyrical.perf_stats(returns, factor_returns=benchmark)
print(stats)
```

输出示例：
```
Annual return          0.1050
Cumulative returns     0.3412
Annual volatility      0.1905
Sharpe ratio           0.5512
Calmar ratio           0.4231
...
```

## 第 4 步：按年分析

查看每年的表现，发现好年份和坏年份：

```python
yearly = pd.DataFrame({
    "年化收益": Empyrical.annual_return_by_year(returns),
    "夏普比率": Empyrical.sharpe_ratio_by_year(returns),
    "最大回撤": Empyrical.max_drawdown_by_year(returns),
})
print(yearly)
```

## 第 5 步：回撤分析

识别最严重的回撤及其持续时间：

```python
# Top 5 回撤
dd_table = Empyrical.gen_drawdown_table(returns, top=5)
print(dd_table)

# 实例方法：回撤天数
emp = Empyrical(returns=returns)
print(f"最大回撤天数:     {emp.max_drawdown_days()}")
print(f"最大回撤恢复天数: {emp.max_drawdown_recovery_days()}")
print(f"第二大回撤:       {emp.second_max_drawdown():.4f}")
```

## 第 6 步：扩展风险指标

```python
emp = Empyrical(returns=returns, factor_returns=benchmark)

print(f"胜率:       {emp.win_rate():.2%}")
print(f"亏损率:     {emp.loss_rate():.2%}")
print(f"斯特林比率: {emp.sterling_ratio():.4f}")
print(f"伯克比率:   {emp.burke_ratio():.4f}")
print(f"特雷诺比率: {emp.treynor_ratio():.4f}")

print(f"\n最大连续上涨: {Empyrical.max_consecutive_up_days(returns)} 天")
print(f"最大连续下跌: {Empyrical.max_consecutive_down_days(returns)} 天")
print(f"单日最大盈利: {Empyrical.max_single_day_gain(returns):.4f}")
print(f"单日最大亏损: {Empyrical.max_single_day_loss(returns):.4f}")
```

## 第 7 步：使用 AnalysisContext

当需要计算大量指标时，AnalysisContext 自动缓存结果：

```python
from fincore import analyze

ctx = analyze(returns, factor_returns=benchmark)

# 所有属性都是 cached_property，首次访问计算后缓存
print(f"夏普: {ctx.sharpe_ratio:.4f}")
print(f"回撤: {ctx.max_drawdown:.4f}")
print(f"Alpha: {ctx.alpha:.4f}")
print(f"Beta: {ctx.beta:.4f}")

# 导出为 JSON（适合存入数据库或 API 返回）
json_str = ctx.to_json(indent=2)
print(json_str)
```

## 第 8 步：生成报告

一行代码生成可分享的 HTML 报告：

```python
fincore.create_strategy_report(
    returns,
    title="我的策略分析报告",
    output="my_strategy_report.html",
)
print("报告已生成!")
```

## 小结

| 步骤 | API | 适用场景 |
|------|-----|---------|
| 快速评估 | `fincore.sharpe_ratio()` | 查看单个指标 |
| 综合统计 | `Empyrical.perf_stats()` | 一次性获取全部核心指标 |
| 按年分析 | `Empyrical.xxx_by_year()` | 发现好/坏年份 |
| 回撤分析 | `Empyrical.gen_drawdown_table()` | 识别最严重的回撤 |
| 扩展指标 | `emp.win_rate()` 等 | 深度风险分析 |
| 缓存分析 | `analyze()` | 大量指标 + 导出 |
| 报告生成 | `create_strategy_report()` | 分享给团队/客户 |

## 下一步

- [进阶教程：风险管理与压力测试](02_进阶_风险管理与压力测试.md)
- 运行 `python examples/quick_start.py` 查看完整可运行示例
