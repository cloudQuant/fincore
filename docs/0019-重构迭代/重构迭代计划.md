# fincore é‡æ„è¿­ä»£è®¡åˆ’

> åŸºäº `docs/0018-æ”¹è¿›ä¼˜åŒ–/é‡æ„å»ºè®®.md`ï¼Œæœ¬æ–‡æ¡£æ˜¯**å¯æ‰§è¡Œçš„è¿­ä»£å·¥ç¨‹è®¡åˆ’**ã€‚
>
> **é“å¾‹**: æ¯æ¬¡è¿­ä»£æäº¤å‰ï¼Œå¿…é¡»é€šè¿‡å…¨éƒ¨ **1233** ä¸ªç°æœ‰æµ‹è¯•ç”¨ä¾‹ã€‚
> ä¸å¾—ä¿®æ”¹æµ‹è¯•ç”¨ä¾‹çš„è¾“å…¥æ•°æ®ã€æœŸæœ›è¾“å‡ºå€¼ã€‚å¯ä»¥ä¿®æ”¹æµ‹è¯•ä¸­çš„ import è·¯å¾„å’Œå‡½æ•°åç§°ã€‚

---

## ä¸€ã€åŸºçº¿ä¿¡æ¯

### 1.1 æµ‹è¯•åŸºçº¿

```
$ python -m pytest tests/ -q --tb=no
1233 passed, 81 warnings in 44.30s
```

**éªŒè¯å‘½ä»¤ï¼ˆæ¯æ¬¡è¿­ä»£å¿…é¡»æ‰§è¡Œï¼‰**:
```bash
python -m pytest tests/ -q --tb=short 2>&1 | tail -5
```

### 1.2 æµ‹è¯•æ–‡ä»¶æ¸…å•ï¼ˆ20ä¸ªæ–‡ä»¶ï¼Œ250ä¸ª test å‡½æ•°ï¼‰

| ç›®å½• | æ–‡ä»¶ | æµ‹è¯•å‡½æ•°æ•° |
|------|------|-----------|
| `test_empyrical/` | `test_stats.py` | 98 |
| `test_empyrical/` | `test_advanced_ratios.py` | 17 |
| `test_empyrical/` | `test_continuous_stats.py` | 16 |
| `test_empyrical/` | `test_special_indicators.py` | 14 |
| `test_empyrical/` | `test_statistical_properties.py` | 12 |
| `test_empyrical/` | `test_annual_alpha_beta.py` | 11 |
| `test_empyrical/` | `test_timing_models.py` | 10 |
| `test_empyrical/` | `test_correlation_analysis.py` | 9 |
| `test_empyrical/` | `test_return_metrics.py` | 8 |
| `test_empyrical/` | `test_ranking_and_cornell.py` | 7 |
| `test_empyrical/` | `test_perf_attrib.py` | 2 |
| `test_pyfolio/` | `test_timeseries.py` | 13 |
| `test_pyfolio/` | `test_tears.py` | 7 |
| `test_pyfolio/` | `test_pos.py` | 7 |
| `test_pyfolio/` | `test_capacity.py` | 5 |
| `test_pyfolio/` | `test_perf_attrib.py` | 5 |
| `test_pyfolio/` | `test_round_trips.py` | 4 |
| `test_pyfolio/` | `test_imports.py` | 3 |
| `test_pyfolio/` | `test_txn.py` | 2 |

### 1.3 æµ‹è¯•ä¸­çš„ import å¥‘çº¦ï¼ˆä¸å¯æ‰“ç ´ï¼‰

ä»¥ä¸‹ import è·¯å¾„åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ï¼Œé‡æ„ä¸­**å¿…é¡»ä¿æŒå¯ç”¨**ï¼š

| import è¯­å¥ | ä½¿ç”¨ä½ç½® |
|-------------|---------|
| `import fincore` | `test_imports.py` |
| `from fincore import Pyfolio` | `test_imports.py`, `test_tears.py` |
| `from fincore import empyrical` | `test_stats.py` |
| `from fincore.empyrical import Empyrical` | 16ä¸ªæµ‹è¯•æ–‡ä»¶ |
| `from fincore.utils import common_utils as emutils` | `test_stats.py` |
| `from fincore.utils.common_utils import (...)` | `test_pos.py`, `test_txn.py`, `test_capacity.py`, `test_timeseries.py`, `test_tears.py` |
| `from fincore.constants import DAILY, WEEKLY, ...` | `test_stats.py` |
| `fincore.__version__` | `test_imports.py` |
| `fincore.utils.common_utils.HAS_IPYTHON` | `test_imports.py` |
| `fincore.utils.common_utils.display` | `test_imports.py` |
| `fincore.utils.common_utils.HTML` | `test_imports.py` |

### 1.4 å½“å‰æºç æ–‡ä»¶æ¸…å•

```
fincore/
â”œâ”€â”€ __init__.py              # å…¥å£ï¼Œå¯¼å‡º Empyrical, Pyfolio
â”œâ”€â”€ empyrical.py             # 1233è¡Œï¼ŒGod Classï¼Œ120+æ–¹æ³•
â”œâ”€â”€ pyfolio.py               # 830è¡Œï¼Œç»§æ‰¿ Empyricalï¼Œç»‘å®šç»˜å›¾
â”œâ”€â”€ constants/
â”‚   â”œâ”€â”€ __init__.py           # æ˜Ÿå·å¯¼å…¥æ‰€æœ‰å­æ¨¡å—
â”‚   â”œâ”€â”€ periods.py            # DAILY, WEEKLY ç­‰å¸¸é‡
â”‚   â”œâ”€â”€ color.py
â”‚   â”œâ”€â”€ interesting_periods.py
â”‚   â””â”€â”€ style.py
â”œâ”€â”€ metrics/
â”‚   â”œâ”€â”€ __init__.py           # 17ä¸ªå­æ¨¡å—çš„å…¨é‡å³æ—¶å¯¼å…¥
â”‚   â”œâ”€â”€ basic.py
â”‚   â”œâ”€â”€ returns.py
â”‚   â”œâ”€â”€ drawdown.py           # 711è¡Œ
â”‚   â”œâ”€â”€ risk.py
â”‚   â”œâ”€â”€ ratios.py
â”‚   â”œâ”€â”€ alpha_beta.py
â”‚   â”œâ”€â”€ stats.py
â”‚   â”œâ”€â”€ consecutive.py
â”‚   â”œâ”€â”€ rolling.py            # 536è¡Œ
â”‚   â”œâ”€â”€ bayesian.py
â”‚   â”œâ”€â”€ positions.py
â”‚   â”œâ”€â”€ transactions.py
â”‚   â”œâ”€â”€ round_trips.py
â”‚   â”œâ”€â”€ perf_attrib.py
â”‚   â”œâ”€â”€ perf_stats.py
â”‚   â”œâ”€â”€ timing.py
â”‚   â””â”€â”€ yearly.py
â”œâ”€â”€ tearsheets/
â”‚   â”œâ”€â”€ __init__.py           # ä»å­æ¨¡å—å¯¼å…¥æ‰€æœ‰ç»˜å›¾å‡½æ•°
â”‚   â”œâ”€â”€ returns.py
â”‚   â”œâ”€â”€ positions.py
â”‚   â”œâ”€â”€ transactions.py
â”‚   â”œâ”€â”€ round_trips.py
â”‚   â”œâ”€â”€ bayesian.py
â”‚   â”œâ”€â”€ risk.py
â”‚   â”œâ”€â”€ perf_attrib.py
â”‚   â”œâ”€â”€ capacity.py
â”‚   â”œâ”€â”€ sheets.py
â”‚   â””â”€â”€ utils.py
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ common_utils.py
â”‚   â”œâ”€â”€ data_utils.py
â”‚   â”œâ”€â”€ date_utils.py
â”‚   â”œâ”€â”€ deprecate.py
â”‚   â””â”€â”€ math_utils.py
â””â”€â”€ datas/                    # æ•°æ®æ–‡ä»¶ç›®å½•
```

### 1.5 ç°æœ‰é…ç½®æ–‡ä»¶

- `setup.py` â€” å®Œæ•´çš„ setuptools é…ç½®
- `pyproject.toml` â€” ä»…æœ‰ `[build-system]` æ®µ
- `requirements.txt` â€” 31è¡Œï¼Œæ··åˆäº†æ ¸å¿ƒ/å¯é€‰/æµ‹è¯•ä¾èµ–

---

## äºŒã€è¿­ä»£æ€»è§ˆ

å…± **6 ä¸ªè¿­ä»£**ï¼Œæ¯ä¸ªè¿­ä»£ç‹¬ç«‹å¯äº¤ä»˜ã€å¯éªŒè¯ã€å¯å›é€€ã€‚

| è¿­ä»£ | åç§° | å‘¨æœŸ | æ ¸å¿ƒäº¤ä»˜ç‰© | é£é™© |
|------|------|------|-----------|------|
| **S1** | ä¾èµ–æ¸…ç† + æ„å»ºç°ä»£åŒ– | 3å¤© | æ¸…ç† sixï¼›å®Œå–„ pyproject.tomlï¼›æ•´ç† requirements.txt | ä½ |
| **S2** | ç±»å‹åŸºç¡€è®¾æ–½ | 5å¤© | `_types.py`ï¼›åº•å±‚æ¨¡å— type hintsï¼›mypy é…ç½® | ä½ |
| **S3** | AnalysisContext ç¼“å­˜å±‚ | 5å¤© | `fincore/core/context.py`ï¼›`fincore.analyze()` API | ä¸­ |
| **S4** | æƒ°æ€§å¯¼å…¥ä¼˜åŒ– | 3å¤© | `__init__.py` æƒ°æ€§åŒ–ï¼›`metrics/__init__.py` æƒ°æ€§åŒ– | ä¸­ |
| **S5** | æ»šåŠ¨è®¡ç®—å‘é‡åŒ– | 5å¤© | `roll_max_drawdown` å‘é‡åŒ–ï¼›`RollingEngine` æ‰¹é‡å¼•æ“ | ä¸­ |
| **S6** | å¯è§†åŒ–è§£è€¦ + HTML æŠ¥å‘Š | 5å¤© | `fincore/viz/` åç«¯åè®®ï¼›HTML æŠ¥å‘Šç”Ÿæˆå™¨ | ä½ |

---

## ä¸‰ã€è¿­ä»£ S1ï¼šä¾èµ–æ¸…ç† + æ„å»ºç°ä»£åŒ–

### ç›®æ ‡
- ç§»é™¤ `six` ç¡¬ä¾èµ–
- å®Œå–„ `pyproject.toml`ï¼Œç»Ÿä¸€æ„å»ºé…ç½®
- æ•´ç† `requirements.txt` ä¸ºå¼€å‘ä¾èµ–æ–‡ä»¶
- éªŒè¯ `pip install -e .` æ­£å¸¸å·¥ä½œ

### å‰ç½®æ£€æŸ¥

```bash
# ç¡®è®¤ six æœªåœ¨æºç ä¸­ç›´æ¥ä½¿ç”¨
grep -r "import six\|from six" fincore/ --include="*.py"
# æœŸæœ›: 0 ç»“æœï¼ˆå·²ç¡®è®¤ï¼‰
```

### ä»»åŠ¡æ¸…å•

#### S1-T1: å®Œå–„ `pyproject.toml`

**æ–‡ä»¶**: `pyproject.toml`

**æ“ä½œ**: å°† `setup.py` ä¸­çš„å…ƒæ•°æ®è¿ç§»åˆ° `pyproject.toml`ã€‚

**å˜æ›´å†…å®¹**:
```toml
[build-system]
requires = ["setuptools>=68.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "fincore"
version = "0.1.0"
description = "Quantitative performance and risk analytics for Python"
readme = "README.md"
license = {text = "MIT"}
requires-python = ">=3.8"
authors = [
    {name = "cloudQuant", email = "yunjinqi@gmail.com"},
]
classifiers = [
    "Development Status :: 4 - Beta",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Programming Language :: Python :: 3.14",
    "License :: OSI Approved :: MIT License",
    "Intended Audience :: Science/Research",
    "Topic :: Scientific/Engineering :: Mathematics",
]
dependencies = [
    "numpy>=1.17.0",
    "pandas>=0.25.0",
    "scipy>=1.3.0",
]

[project.optional-dependencies]
viz = ["matplotlib>=3.3", "seaborn>=0.11"]
bayesian = ["pymc>=5.0"]
datareader = ["pandas-datareader>=0.8.0"]
dev = [
    "pytest>=6.0",
    "pytest-xdist>=2.0",
    "pytest-cov>=2.10",
    "pytest-benchmark>=3.2",
    "pytest-sugar>=0.9",
    "parameterized",
    "ruff>=0.4.0",
    "mypy>=1.5",
]
all = ["fincore[viz,bayesian,datareader]"]

[project.urls]
Homepage = "https://github.com/cloudQuant/fincore"

[tool.setuptools.packages.find]
include = ["fincore*"]

[tool.pytest.ini_options]
testpaths = ["tests"]
addopts = "-q --tb=short"

[tool.mypy]
python_version = "3.10"
warn_return_any = true
warn_unused_configs = true

[tool.ruff]
target-version = "py38"
line-length = 120

[tool.ruff.lint]
select = ["E", "F", "I", "UP", "B", "SIM"]
```

#### S1-T2: ç®€åŒ– `setup.py`

**æ–‡ä»¶**: `setup.py`

**æ“ä½œ**: ç§»é™¤ `six` ä¾èµ–ï¼›ç®€åŒ–ä¸ºæœ€å°é…ç½®ï¼ˆå…ƒæ•°æ®å·²è¿ç§»åˆ° pyproject.tomlï¼‰ã€‚

**å…³é”®å˜æ›´**:
```python
install_requires = [
    "numpy>=1.17.0",
    "pandas>=0.25.0",
    "scipy>=1.3.0",
    # ç§»é™¤: "six>=1.10",
]
```

#### S1-T3: æ•´ç† `requirements.txt`

**æ–‡ä»¶**: `requirements.txt`

**æ“ä½œ**: ä»…ä¿ç•™å¼€å‘/æµ‹è¯•ç”¨é€”çš„ä¾èµ–ï¼ˆæ ¸å¿ƒä¾èµ–ç”± pyproject.toml ç®¡ç†ï¼‰ã€‚

**å˜æ›´åå†…å®¹**:
```
# requirements.txt â€” å¼€å‘ç¯å¢ƒä¾èµ–
# æ ¸å¿ƒä¾èµ–ç”± pyproject.toml ç®¡ç†

# Testing
pytest>=6.0
pytest-xdist>=2.0
pytest-cov>=2.10
pytest-benchmark>=3.2
pytest-sugar>=0.9
parameterized

# Lint & Type Check
ruff>=0.4.0
mypy>=1.5

# Viz (for tearsheets)
matplotlib>=3.3
seaborn>=0.11
ipython>=7.0

# Bayesian (optional)
# pymc>=5.0

# Data (optional)
pandas-datareader>=0.8.0
akshare

# Dev tools
setuptools
packaging
empyrical
scikit-learn
```

### éªŒè¯æ­¥éª¤

```bash
# 1. å®‰è£…éªŒè¯
pip install -e .

# 2. æµ‹è¯•å…¨é€šè¿‡
python -m pytest tests/ -q --tb=short 2>&1 | tail -5
# æœŸæœ›: 1233 passed

# 3. å¯¼å…¥éªŒè¯
python -c "import fincore; print(fincore.__version__)"
```

### å›é€€æ–¹æ¡ˆ
æ¢å¤ `setup.py`ã€`pyproject.toml`ã€`requirements.txt` åˆ°å½“å‰ç‰ˆæœ¬ã€‚

---

## å››ã€è¿­ä»£ S2ï¼šç±»å‹åŸºç¡€è®¾æ–½

### ç›®æ ‡
- åˆ›å»º `fincore/_types.py` ç±»å‹å®šä¹‰æ–‡ä»¶
- ä¸ºåº•å±‚æ¨¡å—ï¼ˆ`basic.py`, `returns.py`ï¼‰æ·»åŠ  type hints
- é…ç½® mypy é€æ¨¡å—æ£€æŸ¥
- **ä¸æ”¹å˜ä»»ä½•å‡½æ•°ç­¾åå’Œè¿”å›å€¼**

### å‰ç½®æ¡ä»¶
- S1 å®Œæˆä¸”æµ‹è¯•å…¨é€šè¿‡

### ä»»åŠ¡æ¸…å•

#### S2-T1: åˆ›å»º `fincore/_types.py`

**æ–°å»ºæ–‡ä»¶**: `fincore/_types.py`

```python
"""Type definitions for fincore."""
from __future__ import annotations

from typing import NamedTuple, Optional, Union, Sequence
import numpy as np
import pandas as pd

# è¾“å…¥ç±»å‹åˆ«å
ArrayLike = Union[pd.Series, np.ndarray, Sequence[float]]
ReturnSeries = Union[pd.Series, np.ndarray]
ReturnOrDataFrame = Union[pd.Series, pd.DataFrame, np.ndarray]

# ç»“æ„åŒ–è¿”å›ç±»å‹
class DrawdownPeriod(NamedTuple):
    peak: pd.Timestamp
    valley: pd.Timestamp
    recovery: Optional[pd.Timestamp]

class AlphaBeta(NamedTuple):
    alpha: float
    beta: float

class BootstrapResult(NamedTuple):
    samples: np.ndarray
    mean: float
    median: float
    ci_lower: float
    ci_upper: float

# å¸¸é‡ç±»å‹
Period = str  # 'daily', 'weekly', 'monthly', 'yearly'
```

#### S2-T2: ä¸º `metrics/basic.py` æ·»åŠ  type hints

**æ–‡ä»¶**: `fincore/metrics/basic.py`

**æ“ä½œ**: åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ  `from __future__ import annotations`ï¼Œä¸ºæ‰€æœ‰å…¬å¼€å‡½æ•°æ·»åŠ å‚æ•°å’Œè¿”å›ç±»å‹æ³¨è§£ã€‚

**çº¦æŸ**: ä»…æ·»åŠ ç±»å‹æ³¨è§£ï¼Œä¸æ”¹å˜ä»»ä½•é€»è¾‘ã€‚

#### S2-T3: ä¸º `metrics/returns.py` æ·»åŠ  type hints

åŒä¸Šæ¨¡å¼ã€‚

#### S2-T4: ä¸º `metrics/drawdown.py` æ·»åŠ  type hints

åŒä¸Šæ¨¡å¼ã€‚å¯å¼•å…¥ `DrawdownPeriod` ä½œä¸ºè¿”å›ç±»å‹ã€‚

**å…¼å®¹æ€§æ³¨æ„**: `DrawdownPeriod` æ˜¯ `NamedTuple`ï¼Œå®Œå…¨å…¼å®¹ `tuple` è§£æ„ã€‚ç°æœ‰æµ‹è¯•ä¸­ `peak, valley, recovery = get_max_drawdown(...)` ä»ç„¶æœ‰æ•ˆã€‚

#### S2-T5: é…ç½® mypy

**æ–°å»ºæ–‡ä»¶**: `mypy.ini`ï¼ˆæˆ–åœ¨ pyproject.toml ä¸­é…ç½®ï¼‰

```ini
[mypy]
python_version = 3.10
warn_return_any = True
warn_unused_configs = True
ignore_missing_imports = True

[mypy-fincore.metrics.basic]
disallow_untyped_defs = True

[mypy-fincore.metrics.returns]
disallow_untyped_defs = True
```

### éªŒè¯æ­¥éª¤

```bash
# 1. æµ‹è¯•å…¨é€šè¿‡
python -m pytest tests/ -q --tb=short 2>&1 | tail -5
# æœŸæœ›: 1233 passed

# 2. mypy æ£€æŸ¥
python -m mypy fincore/_types.py fincore/metrics/basic.py fincore/metrics/returns.py

# 3. NamedTuple å…¼å®¹æ€§éªŒè¯
python -c "
from fincore._types import AlphaBeta
ab = AlphaBeta(alpha=0.05, beta=1.2)
a, b = ab  # tuple è§£æ„ä»æœ‰æ•ˆ
print(f'alpha={a}, beta={b}')
print(f'ab[0]={ab[0]}, ab.alpha={ab.alpha}')
"
```

### å—å½±å“æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | é£é™© |
|------|---------|------|
| `fincore/_types.py` | **æ–°å»º** | æ—  |
| `fincore/metrics/basic.py` | æ·»åŠ ç±»å‹æ³¨è§£ | æä½ |
| `fincore/metrics/returns.py` | æ·»åŠ ç±»å‹æ³¨è§£ | æä½ |
| `fincore/metrics/drawdown.py` | æ·»åŠ ç±»å‹æ³¨è§£ | æä½ |
| `mypy.ini` æˆ– `pyproject.toml` | é…ç½® | æ—  |

### å›é€€æ–¹æ¡ˆ
åˆ é™¤ `_types.py`ï¼Œæ’¤é”€ç±»å‹æ³¨è§£å˜æ›´ã€‚

---

## äº”ã€è¿­ä»£ S3ï¼šAnalysisContext ç¼“å­˜å±‚

### ç›®æ ‡
- åˆ›å»º `fincore/core/` åŒ…
- å®ç° `AnalysisContext` ç±»ï¼ˆ`cached_property` æƒ°æ€§è®¡ç®— + ç¼“å­˜ï¼‰
- å®ç° `fincore.analyze()` ä¾¿æ·å‡½æ•°
- å°† `AnalysisContext` é›†æˆåˆ° `Empyrical.__init__`ï¼ˆå‘åå…¼å®¹ï¼‰
- **ä¸æ”¹å˜ `Empyrical` ä»»ä½•ç°æœ‰æ–¹æ³•ç­¾å**

### å‰ç½®æ¡ä»¶
- S2 å®Œæˆä¸”æµ‹è¯•å…¨é€šè¿‡

### ä»»åŠ¡æ¸…å•

#### S3-T1: åˆ›å»º `fincore/core/` åŒ…

**æ–°å»ºæ–‡ä»¶**:
- `fincore/core/__init__.py`
- `fincore/core/context.py`

`fincore/core/__init__.py`:
```python
"""Core computation engine."""
from fincore.core.context import AnalysisContext, analyze

__all__ = ['AnalysisContext', 'analyze']
```

`fincore/core/context.py`: å®Œæ•´å®ç°è§ `é‡æ„å»ºè®®.md` é˜¶æ®µäºŒã€‚

æ ¸å¿ƒè¦ç‚¹:
- æ‰€æœ‰æŒ‡æ ‡é€šè¿‡ `@cached_property` å®ç°æƒ°æ€§æ±‚å€¼
- `perf_stats()` æ–¹æ³•ç»„è£…ç¼“å­˜çš„å­æŒ‡æ ‡ï¼Œæ— é‡å¤è®¡ç®—
- `invalidate()` æ–¹æ³•æ¸…é™¤æ‰€æœ‰ç¼“å­˜
- `to_dict()` / `to_json()` ä¾¿æ·å¯¼å‡º

#### S3-T2: åœ¨ `fincore/__init__.py` ä¸­æ³¨å†Œ `analyze`

**æ–‡ä»¶**: `fincore/__init__.py`

**å˜æ›´**: æ·»åŠ  `analyze` çš„å¯¼å…¥ï¼Œä¿æŒ `Empyrical` å’Œ `Pyfolio` çš„å¯¼å…¥ä¸å˜ã€‚

```python
__version__ = "0.1"

import numpy as _np
if not hasattr(_np, "unicode_"):
    _np.unicode_ = _np.str_

from .empyrical import Empyrical

try:
    from .pyfolio import Pyfolio
    __all__ = ["Empyrical", "Pyfolio", "analyze"]
except ImportError:
    __all__ = ["Empyrical", "analyze"]

# æ–°å¢å…¥å£
from .core.context import analyze
```

**å…³é”®çº¦æŸ**: `from fincore import empyrical` å¿…é¡»ä»ç„¶æœ‰æ•ˆã€‚`fincore.empyrical` æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œä¸æ˜¯ç±»ï¼Œè¿™ä¸ªè·¯å¾„åœ¨ `test_stats.py` ä¸­ä½¿ç”¨ã€‚

#### S3-T3: åœ¨ `Empyrical.__init__` ä¸­å¯é€‰åˆ›å»ºä¸Šä¸‹æ–‡

**æ–‡ä»¶**: `fincore/empyrical.py`

**å˜æ›´**: åœ¨ `__init__` æœ«å°¾æ·»åŠ å¯é€‰çš„ context åˆ›å»ºï¼š

```python
def __init__(self, returns=None, positions=None, factor_returns=None,
             factor_loadings=None, **kwargs):
    self.returns = returns
    self.positions = positions
    self.factor_returns = factor_returns
    self.factor_loadings = factor_loadings
    # æ–°å¢ï¼šç¼“å­˜ä¸Šä¸‹æ–‡
    self._ctx = None
    if returns is not None:
        try:
            from fincore.core.context import AnalysisContext
            self._ctx = AnalysisContext(
                returns, factor_returns=factor_returns,
                positions=positions,
            )
        except Exception:
            pass  # å›é€€åˆ°æ— ç¼“å­˜æ¨¡å¼
```

#### S3-T4: ç¼–å†™æ–°å¢æµ‹è¯•

**æ–°å»ºæ–‡ä»¶**: `tests/test_core/__init__.py`ã€`tests/test_core/test_context.py`

```python
# tests/test_core/test_context.py
"""Tests for AnalysisContext â€” æ–°å¢æµ‹è¯•ï¼Œä¸ä¿®æ”¹ç°æœ‰æµ‹è¯•ã€‚"""
import numpy as np
import pandas as pd
import pytest

class TestAnalysisContext:
    @pytest.fixture
    def returns(self):
        np.random.seed(42)
        return pd.Series(np.random.randn(504) * 0.01,
                         index=pd.bdate_range('2020-01-01', periods=504))

    @pytest.fixture
    def benchmark(self, returns):
        np.random.seed(123)
        return pd.Series(np.random.randn(504) * 0.008, index=returns.index)

    def test_basic_creation(self, returns):
        from fincore.core.context import AnalysisContext
        ctx = AnalysisContext(returns)
        assert repr(ctx).startswith("AnalysisContext(")

    def test_sharpe_ratio_cached(self, returns):
        from fincore.core.context import AnalysisContext
        ctx = AnalysisContext(returns)
        sr1 = ctx.sharpe_ratio
        sr2 = ctx.sharpe_ratio
        assert sr1 == sr2

    def test_perf_stats_keys(self, returns):
        from fincore.core.context import AnalysisContext
        ctx = AnalysisContext(returns)
        stats = ctx.perf_stats()
        assert 'Annual return' in stats.index
        assert 'Max drawdown' in stats.index
        assert 'Sharpe ratio' in stats.index

    def test_perf_stats_matches_standalone(self, returns, benchmark):
        from fincore.core.context import AnalysisContext
        from fincore.metrics.perf_stats import perf_stats
        ctx = AnalysisContext(returns, factor_returns=benchmark)
        ctx_stats = ctx.perf_stats()
        standalone = perf_stats(returns, factor_returns=benchmark)
        for key in standalone.index:
            if key in ctx_stats.index:
                np.testing.assert_allclose(
                    ctx_stats[key], standalone[key], rtol=1e-10,
                    err_msg=f"Mismatch in {key}")

    def test_invalidate(self, returns):
        from fincore.core.context import AnalysisContext
        ctx = AnalysisContext(returns)
        sr1 = ctx.sharpe_ratio
        ctx.invalidate()
        sr2 = ctx.sharpe_ratio
        assert sr1 == sr2

    def test_analyze_convenience(self, returns):
        from fincore.core.context import analyze
        ctx = analyze(returns)
        assert ctx.sharpe_ratio is not None

    def test_to_dict(self, returns):
        from fincore.core.context import AnalysisContext
        ctx = AnalysisContext(returns)
        d = ctx.to_dict()
        assert isinstance(d, dict)
        assert 'Sharpe ratio' in d

    def test_alpha_beta_without_benchmark(self, returns):
        from fincore.core.context import AnalysisContext
        ctx = AnalysisContext(returns)
        assert np.isnan(ctx.alpha)
        assert np.isnan(ctx.beta)

    def test_alpha_beta_with_benchmark(self, returns, benchmark):
        from fincore.core.context import AnalysisContext
        ctx = AnalysisContext(returns, factor_returns=benchmark)
        assert np.isfinite(ctx.alpha)
        assert np.isfinite(ctx.beta)
```

### éªŒè¯æ­¥éª¤

```bash
# 1. ç°æœ‰æµ‹è¯•å…¨é€šè¿‡ï¼ˆæœ€é‡è¦ï¼‰
python -m pytest tests/test_empyrical/ tests/test_pyfolio/ -q --tb=short 2>&1 | tail -5
# æœŸæœ›: 1233 passed

# 2. æ–°å¢æµ‹è¯•é€šè¿‡
python -m pytest tests/test_core/ -q --tb=short

# 3. åŠŸèƒ½éªŒè¯
python -c "
import fincore
import pandas as pd, numpy as np
np.random.seed(42)
returns = pd.Series(np.random.randn(252) * 0.01,
                    index=pd.bdate_range('2020-01-01', periods=252))
ctx = fincore.analyze(returns)
print(ctx)
print(ctx.perf_stats())
"

# 4. å‘åå…¼å®¹éªŒè¯
python -c "
from fincore import empyrical
from fincore.empyrical import Empyrical
from fincore import Pyfolio
print('All legacy imports OK')
"
```

### å—å½±å“æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | é£é™© |
|------|---------|------|
| `fincore/core/__init__.py` | **æ–°å»º** | æ—  |
| `fincore/core/context.py` | **æ–°å»º** | æ—  |
| `fincore/__init__.py` | æ·»åŠ  `analyze` å¯¼å…¥ | ä½ |
| `fincore/empyrical.py` | `__init__` æ·»åŠ å¯é€‰ `_ctx` | ä½ |
| `tests/test_core/__init__.py` | **æ–°å»º** | æ—  |
| `tests/test_core/test_context.py` | **æ–°å»º** | æ—  |

### å›é€€æ–¹æ¡ˆ
åˆ é™¤ `fincore/core/` ç›®å½•ï¼Œæ¢å¤ `__init__.py` å’Œ `empyrical.py`ã€‚

---

## å…­ã€è¿­ä»£ S4ï¼šæƒ°æ€§å¯¼å…¥ä¼˜åŒ–

### ç›®æ ‡
- `import fincore` ä¸å†è§¦å‘ matplotlib/seaborn/pymc çš„å¯¼å…¥é“¾
- `fincore/metrics/__init__.py` æ”¹ä¸ºæƒ°æ€§å¯¼å…¥
- ä¿æŒæ‰€æœ‰ç°æœ‰ import è·¯å¾„å¯ç”¨

### å‰ç½®æ¡ä»¶
- S3 å®Œæˆä¸”æµ‹è¯•å…¨é€šè¿‡

### å…³é”®çº¦æŸ

ä»¥ä¸‹ import è·¯å¾„å¿…é¡»åœ¨æƒ°æ€§åŒ–åä»ç„¶å¯ç”¨ï¼š

```python
# æµ‹è¯•ä¸­ä½¿ç”¨çš„è·¯å¾„
import fincore                            # test_imports.py
from fincore import Pyfolio               # test_imports.py, test_tears.py
from fincore import empyrical             # test_stats.py (empyrical æ˜¯æ¨¡å—)
from fincore.empyrical import Empyrical   # 16ä¸ªæµ‹è¯•æ–‡ä»¶
fincore.__version__                       # test_imports.py
```

### ä»»åŠ¡æ¸…å•

#### S4-T1: æƒ°æ€§åŒ– `fincore/__init__.py`

**æ–‡ä»¶**: `fincore/__init__.py`

**æ“ä½œ**: å°†å³æ—¶å¯¼å…¥æ”¹ä¸º `__getattr__` æƒ°æ€§å¯¼å…¥ã€‚

**å…³é”®å®ç°**:
```python
__version__ = "0.1"

import numpy as _np
if not hasattr(_np, "unicode_"):
    _np.unicode_ = _np.str_

__all__ = ["Empyrical", "Pyfolio", "analyze"]

def __getattr__(name):
    if name == "Empyrical":
        from .empyrical import Empyrical
        globals()["Empyrical"] = Empyrical
        return Empyrical
    if name == "Pyfolio":
        from .pyfolio import Pyfolio
        globals()["Pyfolio"] = Pyfolio
        return Pyfolio
    if name == "analyze":
        from .core.context import analyze
        globals()["analyze"] = analyze
        return analyze
    raise AttributeError(f"module 'fincore' has no attribute {name!r}")
```

**ç‰¹åˆ«æ³¨æ„**: `from fincore import empyrical` è®¿é—®çš„æ˜¯ `fincore.empyrical` **æ¨¡å—**ï¼ˆä¸æ˜¯ç±»ï¼‰ï¼ŒPython çš„æ¨¡å—å¯¼å…¥ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å­æ¨¡å—è®¿é—®ï¼Œæ— éœ€åœ¨ `__getattr__` ä¸­ç‰¹æ®Šå¤„ç†ã€‚éªŒè¯æ–¹å¼ï¼š

```python
# è¿™åº”è¯¥ä»ç„¶æœ‰æ•ˆ:
from fincore import empyrical
# empyrical æ˜¯ fincore/empyrical.py æ¨¡å—å¯¹è±¡
```

#### S4-T2: æƒ°æ€§åŒ– `fincore/metrics/__init__.py`

**æ–‡ä»¶**: `fincore/metrics/__init__.py`

**æ“ä½œ**: å°† 17 ä¸ªå­æ¨¡å—çš„å³æ—¶å¯¼å…¥æ”¹ä¸º `__getattr__` æƒ°æ€§å¯¼å…¥ã€‚

```python
"""Metrics - æ‹†åˆ†åçš„é‡‘èæ€§èƒ½åˆ†æå‡½æ•°æ¨¡å—."""

import importlib as _importlib

_MODULE_MAP = {
    'basic_module': 'fincore.metrics.basic',
    'returns_module': 'fincore.metrics.returns',
    'drawdown_module': 'fincore.metrics.drawdown',
    'risk_module': 'fincore.metrics.risk',
    'ratios_module': 'fincore.metrics.ratios',
    'alpha_beta_module': 'fincore.metrics.alpha_beta',
    'stats_module': 'fincore.metrics.stats',
    'consecutive_module': 'fincore.metrics.consecutive',
    'rolling_module': 'fincore.metrics.rolling',
    'bayesian_module': 'fincore.metrics.bayesian',
    'positions_module': 'fincore.metrics.positions',
    'transactions_module': 'fincore.metrics.transactions',
    'round_trips_module': 'fincore.metrics.round_trips',
    'perf_attrib_module': 'fincore.metrics.perf_attrib',
    'perf_stats_module': 'fincore.metrics.perf_stats',
    'timing_module': 'fincore.metrics.timing',
    'yearly_module': 'fincore.metrics.yearly',
}

def __getattr__(name):
    if name in _MODULE_MAP:
        mod = _importlib.import_module(_MODULE_MAP[name])
        globals()[name] = mod
        return mod
    raise AttributeError(f"module 'fincore.metrics' has no attribute {name!r}")
```

**é£é™©åˆ†æ**: `empyrical.py` é¡¶å±‚æœ‰ `from fincore.metrics import basic_module as _basic` ç­‰è¯­å¥ã€‚å½“ `empyrical.py` è¢«å¯¼å…¥æ—¶ï¼ŒPython ä¼šå…ˆå¯¼å…¥ `fincore.metrics`ï¼Œç„¶åé€šè¿‡ `__getattr__` è§£æ `basic_module`ã€‚è¿™åº”è¯¥æ˜¯å…¼å®¹çš„ï¼Œå› ä¸º `__getattr__` åœ¨å±æ€§è®¿é—®æ—¶è§¦å‘ã€‚ä½†éœ€è¦éªŒè¯ `from fincore.metrics import basic_module` æ˜¯å¦è§¦å‘ `__getattr__`ï¼ˆç­”æ¡ˆæ˜¯ **æ˜¯çš„**ï¼Œ`from package import name` ä¼šè°ƒç”¨ `package.__getattr__(name)` å¦‚æœ `name` ä¸åœ¨ `__dict__` ä¸­ï¼‰ã€‚

#### S4-T3: éªŒè¯ empyrical.py çš„å¯¼å…¥å…¼å®¹æ€§

`empyrical.py` é¡¶å±‚æœ‰ï¼ˆç¬¬69-85è¡Œï¼‰ï¼š
```python
from fincore.metrics import basic_module as _basic
from fincore.metrics import returns_module as _returns
...
```

è¿™äº› `from ... import` ä¼šè§¦å‘ `metrics/__init__.py` çš„ `__getattr__`ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯å…¼å®¹çš„ã€‚ä½† `empyrical.py` åœ¨æ¨¡å—åŠ è½½æ—¶å°±éœ€è¦è¿™äº›å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬ä¼šåœ¨ `import fincore.empyrical` æ—¶ç«‹å³åŠ è½½â€”â€”è¿™æ˜¯é¢„æœŸçš„è¡Œä¸ºï¼ˆ`Empyrical` æœ¬èº«ç¡®å®éœ€è¦è¿™äº›ï¼‰ã€‚

**æƒ°æ€§å¯¼å…¥çš„æ”¶ç›Šæ¥è‡ª**: `import fincore` ä¸å†ç«‹å³å¯¼å…¥ `empyrical.py`ï¼ˆä»¥åŠå®ƒçš„ 17 ä¸ª metrics å­æ¨¡å—ï¼‰ï¼Œç›´åˆ°ç”¨æˆ·å®é™…è®¿é—® `fincore.Empyrical` æ—¶æ‰è§¦å‘ã€‚

### éªŒè¯æ­¥éª¤

```bash
# 1. å¯¼å…¥é€Ÿåº¦æµ‹è¯•
python -c "
import time
t0 = time.time()
import fincore
t1 = time.time()
print(f'import fincore: {t1-t0:.3f}s')

t0 = time.time()
_ = fincore.Empyrical
t1 = time.time()
print(f'access Empyrical: {t1-t0:.3f}s')
"

# 2. æ‰€æœ‰ import å¥‘çº¦éªŒè¯
python -c "
import fincore
assert hasattr(fincore, '__version__')
from fincore import Pyfolio
from fincore import empyrical
from fincore.empyrical import Empyrical
from fincore.utils import common_utils
from fincore.constants import DAILY, WEEKLY, MONTHLY
from fincore.core.context import analyze
print('All imports OK')
"

# 3. ç°æœ‰æµ‹è¯•å…¨é€šè¿‡
python -m pytest tests/ -q --tb=short 2>&1 | tail -5
# æœŸæœ›: 1233+ passed
```

### å—å½±å“æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | é£é™© |
|------|---------|------|
| `fincore/__init__.py` | é‡å†™ä¸ºæƒ°æ€§å¯¼å…¥ | ä¸­ |
| `fincore/metrics/__init__.py` | é‡å†™ä¸ºæƒ°æ€§å¯¼å…¥ | ä¸­ |

### å›é€€æ–¹æ¡ˆ
æ¢å¤ä¸¤ä¸ª `__init__.py` åˆ°å³æ—¶å¯¼å…¥ç‰ˆæœ¬ã€‚

### é£é™©ä¸ç¼“è§£

| é£é™© | ç¼“è§£ |
|------|------|
| å¾ªç¯å¯¼å…¥ | `__getattr__` åªåœ¨å±æ€§è®¿é—®æ—¶è§¦å‘ï¼Œä¸ä¼šåœ¨æ¨¡å—åŠ è½½æ—¶è§¦å‘å¾ªç¯ |
| `from fincore import empyrical` å¤±è´¥ | Python ä¼šå…ˆæŸ¥å­æ¨¡å—å†æŸ¥ `__getattr__`ï¼Œå­æ¨¡å—è·¯å¾„ä¼˜å…ˆ |
| `empyrical.py` çš„é¡¶å±‚ `from fincore.metrics import` å¤±è´¥ | `__getattr__` æ”¯æŒ `from ... import` è¯­æ³• |

---

## ä¸ƒã€è¿­ä»£ S5ï¼šæ»šåŠ¨è®¡ç®—å‘é‡åŒ–

### ç›®æ ‡
- å‘é‡åŒ– `roll_max_drawdown`ï¼ˆå½“å‰ for å¾ªç¯ï¼‰ï¼Œæé€Ÿ 10-50x
- åˆ›å»º `RollingEngine` æ‰¹é‡è®¡ç®—å¼•æ“
- **ä¸æ”¹å˜å‡½æ•°ç­¾åå’Œè¿”å›å€¼æ ¼å¼**

### å‰ç½®æ¡ä»¶
- S4 å®Œæˆä¸”æµ‹è¯•å…¨é€šè¿‡

### ä»»åŠ¡æ¸…å•

#### S5-T1: å‘é‡åŒ– `roll_max_drawdown`

**æ–‡ä»¶**: `fincore/metrics/rolling.py`

**æ“ä½œ**: å°†ç¬¬ 254-295 è¡Œçš„ for å¾ªç¯æ›¿æ¢ä¸º `numpy.lib.stride_tricks.sliding_window_view` å®ç°ã€‚

**å®ç°** è§ `é‡æ„å»ºè®®.md` é˜¶æ®µä¸‰ 3.1ã€‚

**å…¼å®¹æ€§æ£€æŸ¥**:
- è¾“å…¥: `pd.Series` æˆ– `np.ndarray` â†’ ä¸å˜
- è¾“å‡º: `pd.Series`ï¼ˆå¸¦ indexï¼‰æˆ– `np.ndarray` â†’ ä¸å˜
- è¿”å›å€¼æ•°å€¼ â†’ å¿…é¡»ä¸åŸå§‹ for å¾ªç¯å®Œå…¨ä¸€è‡´ï¼ˆrtol=1e-12ï¼‰

**æµ‹è¯•ç­–ç•¥**: åœ¨æ›¿æ¢å‰å…ˆä¿å­˜åŸå§‹å®ç°ä½œä¸º `_roll_max_drawdown_loop`ï¼Œç”¨äºå¯¹æ¯”éªŒè¯ã€‚

#### S5-T2: åˆ›å»º `fincore/core/engine.py`

**æ–°å»ºæ–‡ä»¶**: `fincore/core/engine.py`

å®ç° `RollingEngine` ç±»ï¼Œè§ `é‡æ„å»ºè®®.md` é˜¶æ®µä¸‰ 3.3ã€‚

**å…³é”®è®¾è®¡**:
- å¯å‘é‡åŒ–æŒ‡æ ‡ï¼ˆsharpe, beta, volatility, max_drawdownï¼‰å§”æ‰˜ç»™ç°æœ‰å‡½æ•°
- ä¸å¯å‘é‡åŒ–æŒ‡æ ‡ï¼ˆalpha, up/down captureï¼‰åœ¨å•æ¬¡ for å¾ªç¯ä¸­æ‰¹é‡è®¡ç®—
- è¿”å› `dict[str, pd.Series]`

#### S5-T3: ç¼–å†™å‘é‡åŒ–æµ‹è¯•

**æ–°å»ºæ–‡ä»¶**: `tests/test_core/test_engine.py`

```python
class TestRollingEngine:
    def test_compute_sharpe(self, returns):
        from fincore.core.engine import RollingEngine
        engine = RollingEngine(returns, window=60)
        results = engine.compute(['sharpe'])
        assert 'sharpe' in results
        assert len(results['sharpe']) > 0

    def test_vectorized_matches_loop(self, returns):
        """Ensure vectorized roll_max_drawdown matches original."""
        from fincore.metrics.rolling import roll_max_drawdown
        result = roll_max_drawdown(returns, window=60)
        # å¯¹æ¯”åŸå§‹ for å¾ªç¯ç»“æœ...
```

### éªŒè¯æ­¥éª¤

```bash
# 1. ç°æœ‰æµ‹è¯•å…¨é€šè¿‡
python -m pytest tests/test_empyrical/ tests/test_pyfolio/ -q --tb=short 2>&1 | tail -5
# æœŸæœ›: 1233 passed

# 2. æ–°å¢æµ‹è¯•é€šè¿‡
python -m pytest tests/test_core/ -q --tb=short

# 3. æ€§èƒ½éªŒè¯
python -c "
import time, numpy as np, pandas as pd
from fincore.metrics.rolling import roll_max_drawdown
np.random.seed(42)
returns = pd.Series(np.random.randn(2520) * 0.01,
                    index=pd.bdate_range('2010-01-01', periods=2520))
t0 = time.time()
for _ in range(10):
    roll_max_drawdown(returns, window=252)
elapsed = (time.time() - t0) / 10
print(f'roll_max_drawdown: {elapsed:.4f}s per call')
"
```

### å—å½±å“æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | é£é™© |
|------|---------|------|
| `fincore/metrics/rolling.py` | `roll_max_drawdown` é‡å†™ | ä¸­ |
| `fincore/core/engine.py` | **æ–°å»º** | æ—  |
| `tests/test_core/test_engine.py` | **æ–°å»º** | æ—  |

### å›é€€æ–¹æ¡ˆ
æ¢å¤ `rolling.py` ä¸­çš„ `roll_max_drawdown` åˆ° for å¾ªç¯ç‰ˆæœ¬ã€‚

---

## å…«ã€è¿­ä»£ S6ï¼šå¯è§†åŒ–è§£è€¦ + HTML æŠ¥å‘Š

### ç›®æ ‡
- åˆ›å»º `fincore/viz/` å¯è§†åŒ–åç«¯åŒ…
- å®ç° `VizBackend` åè®® + Matplotlib åç«¯
- å®ç° HTML æŠ¥å‘Šç”Ÿæˆå™¨
- åœ¨ `AnalysisContext` ä¸­é›†æˆ `plot()` å’Œ `to_html()` æ–¹æ³•
- **ä¸æ”¹å˜ç°æœ‰ tearsheets/ çš„ä»»ä½•ä»£ç **

### å‰ç½®æ¡ä»¶
- S5 å®Œæˆä¸”æµ‹è¯•å…¨é€šè¿‡

### ä»»åŠ¡æ¸…å•

#### S6-T1: åˆ›å»ºå¯è§†åŒ–åç«¯åè®®

**æ–°å»ºæ–‡ä»¶**:
- `fincore/viz/__init__.py`
- `fincore/viz/base.py`
- `fincore/viz/matplotlib_backend.py`
- `fincore/viz/html_backend.py`

å®ç°è§ `é‡æ„å»ºè®®.md` é˜¶æ®µå››ã€‚

#### S6-T2: åœ¨ `AnalysisContext` ä¸­æ·»åŠ å¯è§†åŒ–æ–¹æ³•

**æ–‡ä»¶**: `fincore/core/context.py`

**æ–°å¢æ–¹æ³•**: `plot()`, `to_html()`

#### S6-T3: ç¼–å†™å¯è§†åŒ–æµ‹è¯•

**æ–°å»ºæ–‡ä»¶**: `tests/test_core/test_viz.py`

### éªŒè¯æ­¥éª¤

```bash
# 1. ç°æœ‰æµ‹è¯•å…¨é€šè¿‡
python -m pytest tests/test_empyrical/ tests/test_pyfolio/ -q --tb=short 2>&1 | tail -5
# æœŸæœ›: 1233 passed

# 2. æ–°å¢æµ‹è¯•é€šè¿‡
python -m pytest tests/test_core/ -q --tb=short

# 3. HTML æŠ¥å‘ŠåŠŸèƒ½éªŒè¯
python -c "
import fincore
import pandas as pd, numpy as np
np.random.seed(42)
returns = pd.Series(np.random.randn(252) * 0.01,
                    index=pd.bdate_range('2020-01-01', periods=252))
ctx = fincore.analyze(returns)
from fincore.viz.html_backend import HtmlReportBuilder
report = HtmlReportBuilder(ctx)
report.add_stats_table()
html = report.build()
print(f'HTML report: {len(html)} chars')
"
```

### å—å½±å“æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | é£é™© |
|------|---------|------|
| `fincore/viz/__init__.py` | **æ–°å»º** | æ—  |
| `fincore/viz/base.py` | **æ–°å»º** | æ—  |
| `fincore/viz/matplotlib_backend.py` | **æ–°å»º** | æ—  |
| `fincore/viz/html_backend.py` | **æ–°å»º** | æ—  |
| `fincore/core/context.py` | æ·»åŠ æ–¹æ³• | ä½ |
| `tests/test_core/test_viz.py` | **æ–°å»º** | æ—  |

### å›é€€æ–¹æ¡ˆ
åˆ é™¤ `fincore/viz/` ç›®å½•ï¼Œæ’¤é”€ `context.py` çš„æ–°å¢æ–¹æ³•ã€‚

---

## ä¹ã€é€šç”¨è§„åˆ™

### 9.1 Git æäº¤è§„èŒƒ

æ¯ä¸ªä»»åŠ¡ï¼ˆTï¼‰ä¸€ä¸ªåŸå­æäº¤ï¼Œæäº¤æ¶ˆæ¯æ ¼å¼:

```
[S{n}-T{m}] ç®€çŸ­æè¿°

è¯¦ç»†è¯´æ˜å˜æ›´å†…å®¹ã€‚
å—å½±å“æ–‡ä»¶: file1.py, file2.py
```

ç¤ºä¾‹:
```
[S1-T1] å®Œå–„ pyproject.toml æ„å»ºé…ç½®

å°† setup.py å…ƒæ•°æ®è¿ç§»åˆ° pyproject.tomlã€‚
æ·»åŠ å¯é€‰ä¾èµ–åˆ†ç»„: viz, bayesian, datareader, devã€‚
å—å½±å“æ–‡ä»¶: pyproject.toml
```

### 9.2 æ¯æ¬¡æäº¤å‰çš„å¿…é¡»æ£€æŸ¥

```bash
# 1. å…¨é‡æµ‹è¯•
python -m pytest tests/ -q --tb=short

# 2. å¯¼å…¥å¥‘çº¦
python -c "
import fincore
from fincore import Pyfolio, empyrical
from fincore.empyrical import Empyrical
from fincore.utils import common_utils
from fincore.constants import DAILY
print('OK')
"

# 3. æ— è¯­æ³•é”™è¯¯
python -m py_compile fincore/__init__.py
python -m py_compile fincore/empyrical.py
python -m py_compile fincore/pyfolio.py
```

### 9.3 ä¸å¯ä¿®æ”¹çš„æµ‹è¯•çº¦æŸ

| çº¦æŸ | è¯´æ˜ |
|------|------|
| æµ‹è¯•è¾“å…¥æ•°æ® | ä¸å¾—ä¿®æ”¹æµ‹è¯•ä¸­çš„ `pd.Series(...)` ç­‰è¾“å…¥æ•°æ® |
| æœŸæœ›è¾“å‡ºå€¼ | ä¸å¾—ä¿®æ”¹ `assert_almost_equal(result, 0.xxxx)` ä¸­çš„æœŸæœ›å€¼ |
| æ–­è¨€ç²¾åº¦ | ä¸å¾—é™ä½ `DECIMAL_PLACES` |
| å…è®¸ä¿®æ”¹ | `import` è¯­å¥ã€ç±»åå¼•ç”¨ã€å‡½æ•°åå¼•ç”¨ï¼ˆå¦‚é‡å‘½ååï¼‰ |

### 9.4 æ–‡ä»¶å˜æ›´å½±å“çŸ©é˜µ

æ ‡è®°æ¯ä¸ªè¿­ä»£ä¼šè§¦ç¢°çš„æ–‡ä»¶ï¼Œç”¨äºå†²çªé¢„é˜²ï¼š

| æ–‡ä»¶ | S1 | S2 | S3 | S4 | S5 | S6 |
|------|:--:|:--:|:--:|:--:|:--:|:--:|
| `pyproject.toml` | âœï¸ | | | | | |
| `setup.py` | âœï¸ | | | | | |
| `requirements.txt` | âœï¸ | | | | | |
| `fincore/__init__.py` | | | âœï¸ | âœï¸ | | |
| `fincore/empyrical.py` | | | âœï¸ | | | |
| `fincore/_types.py` | | ğŸ†• | | | | |
| `fincore/metrics/__init__.py` | | | | âœï¸ | | |
| `fincore/metrics/basic.py` | | âœï¸ | | | | |
| `fincore/metrics/returns.py` | | âœï¸ | | | | |
| `fincore/metrics/drawdown.py` | | âœï¸ | | | | |
| `fincore/metrics/rolling.py` | | | | | âœï¸ | |
| `fincore/core/__init__.py` | | | ğŸ†• | | | |
| `fincore/core/context.py` | | | ğŸ†• | | | âœï¸ |
| `fincore/core/engine.py` | | | | | ğŸ†• | |
| `fincore/viz/*.py` | | | | | | ğŸ†• |
| `tests/test_core/*.py` | | | ğŸ†• | | ğŸ†• | ğŸ†• |
| `mypy.ini` | | ğŸ†• | | | | |

âœï¸ = ä¿®æ”¹ç°æœ‰æ–‡ä»¶ &emsp; ğŸ†• = æ–°å»ºæ–‡ä»¶

---

## åã€éªŒæ”¶æ ‡å‡†

### æœ€ç»ˆéªŒæ”¶æ£€æŸ¥æ¸…å•

- [ ] `python -m pytest tests/ -q` â†’ 1233+ passedï¼Œ0 failed
- [ ] `import fincore` è€—æ—¶ < 0.2sï¼ˆç›®æ ‡ < 0.1sï¼‰
- [ ] `fincore.analyze(returns).perf_stats()` å¯æ­£å¸¸å·¥ä½œ
- [ ] `fincore.analyze(returns).sharpe_ratio` è¿”å› float
- [ ] `from fincore import Empyrical, Pyfolio` å‘åå…¼å®¹
- [ ] `from fincore import empyrical` å‘åå…¼å®¹
- [ ] `fincore.analyze(returns).to_json()` å¯å¯¼å‡º JSON
- [ ] `HtmlReportBuilder` å¯ç”Ÿæˆ HTML æŠ¥å‘Š
- [ ] `RollingEngine` å¯æ‰¹é‡è®¡ç®—æ»šåŠ¨æŒ‡æ ‡
- [ ] `roll_max_drawdown` å‘é‡åŒ–åæ€§èƒ½æå‡ â‰¥ 5x
- [ ] type hints è¦†ç›– `_types.py`, `basic.py`, `returns.py`, `drawdown.py`
- [ ] mypy å¯¹å·²æ ‡æ³¨æ¨¡å—é€šè¿‡æ£€æŸ¥
- [ ] `pyproject.toml` åŒ…å«å®Œæ•´é¡¹ç›®é…ç½®
- [ ] æ—  `six` ç¡¬ä¾èµ–

---

## åä¸€ã€æ—¶é—´çº¿

```
Week 1:  [S1] ä¾èµ–æ¸…ç† â”€â”€â”€â”€â”€â”€â–º [S2-T1~T2] ç±»å‹å®šä¹‰ + basic.py
Week 2:  [S2-T3~T5] æ›´å¤š type hints + mypy â”€â”€â”€â”€â”€â”€â–º [S3-T1~T2] AnalysisContext
Week 3:  [S3-T3~T4] é›†æˆ + æµ‹è¯• â”€â”€â”€â”€â”€â”€â–º [S4] æƒ°æ€§å¯¼å…¥
Week 4:  [S5] æ»šåŠ¨è®¡ç®—å‘é‡åŒ–
Week 5:  [S6] å¯è§†åŒ–è§£è€¦ + HTML æŠ¥å‘Š â”€â”€â”€â”€â”€â”€â–º æœ€ç»ˆéªŒæ”¶
```
