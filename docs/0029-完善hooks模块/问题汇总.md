# fincore 项目问题汇总

## 发现日期

2026-02-12

---

## 🔴 P0 级别 (关键问题)

### P0-1: hooks 模块架构不完整

**严重程度**: 🔴 CRITICAL

**描述**: `fincore/hooks/events/` 目录为空，导致整个 hooks 系统不可用。

**影响**:
- `from fincore.hooks import *` 失败
- 10 个 mypy 类型错误
- 违反 0027 迭代中"插件系统"的完成声明

**文件**: `docs/0029-完善hooks模块/README.md`

---

### P0-2: `__init__.py` 中 `unicode_` 兼容性代码无效

**严重程度**: 🔴 HIGH

**描述**: NumPy 2.0 兼容性代码不工作。

**mypy 错误**:
```
fincore/__init__.py:10: error: Module has no attribute "unicode_"  [attr-defined]
```

**原因**: 赋值 `_np.unicode_ = _np.str_` 不会创建模块级属性。

---

## 🟡 P1 级别 (重要问题)

### P1-1: Mypy 类型错误 (51 个)

**按模块分布**:

| 模块 | 错误数 |
|--------|---------|
| fincore/hooks/__init__.py | 10 |
| fincore/attribution/ | 17 |
| fincore/risk/garch.py | 6 |
| fincore/plugin/ | 6 |
| fincore/data/providers.py | 8 |
| fincore/viz/interactive/ | 2 |
| fincore/metrics/ | 2 |
| fincore/simulation/ | 1 |

**主要问题模式**:

1. **`np.corr()` 不存在** - 应使用 `np.corrcoef()`
2. **可选值处理不当** - `None` 值未检查就调用方法
3. **返回类型不匹配** - 返回 `dict` 而非预期的 `float | ndarray`
4. **缺少 return 语句** - 某些代码路径没有返回值

---

### P1-2: 异常处理过于宽泛 (52 处)

**示例**:
```python
# fincore/report.py:164
except Exception:
    pass  # ❌ 吞掉所有异常
```

**建议**: 捕获具体异常类型：
```python
except (ValueError, TypeError) as e:
    logger.warning(f"Calculation failed: {e}")
```

**分布**:
- `fincore/data/providers.py`: 9 处
- `fincore/report.py`: 8 处
- `fincore/utils/common_utils.py`: 10 处
- 其他模块: 25 处

---

### P1-3: 中文 print 语句混杂 (91 处)

**示例**:
```python
# fincore/utils/common_utils.py
print("文件已成功保存到：{excel_file_path}")
print("保存文件时出错：{e}")
```

**问题**:
- 不利于国际化
- 混杂代码逻辑与输出
- 应使用 logging 模块

---

## 🟢 P2 级别 (改进建议)

### P2-1: TODO/FIXME 标记 (3 处)

| 位置 | 内容 |
|------|------|
| `fama_french.py:1` | TODO: 实现缓存 |
| `style.py:1` | TODO: 添加国际风格数据 |
| `constants/style.py:146` | FIXME: 持续时间计算 |

---

### P2-2: 代码规模指标

| 指标 | 数值 |
|--------|------|
| Python 文件 | 49 |
| 总代码行数 | 25,087 |
| 最大文件 | `report.py` (1,578 行) |
| 类定义 | 726 |
| 函数定义 | ~3,500 |

**建议**: `report.py` (1578行) 和 `pyfolio.py` (1050行) 可考虑拆分。

---

### P2-3: 已编译文件 (109 个目录)

**发现**: 109 个 `__pycache__` 目录未被版本控制排除

**状态**: ✅ `.gitignore` 已正确配置

**建议**: 添加 `.gitignore` 检查到 CI 流程中。

---

## 修复优先级

| 优先级 | 问题 | 预计时间 |
|--------|------|----------|
| P0 | hooks 模块实现 | 2-3 小时 |
| P0 | unicode_ 兼容性修复 | 10 分钟 |
| P1 | 类型错误修复 | 3-4 小时 |
| P1 | 异常处理改进 | 2-3 小时 |
| P1 | 替换 print 为 logging | 1-2 小时 |
| P2 | 处理 TODO 标记 | 1 小时 |

---

**总计**: 约 10-15 小时开发工作量

---

## 下一步行动

1. ✅ **0028 迭代已完成** - 代码质量优化
2. 📋 **0029 迭代规划** - 完善 hooks 模块
3. 📋 **0030 迭代建议** - 类型系统改进

---

**当前项目状态**:

| 模块 | 状态 | 测试 |
|------|------|------|
| 核心指标 (metrics/) | ✅ | 1000+ passed |
| EVT/GARCH (risk/) | ✅ | 27 passed |
| 蒙特卡洛 (simulation/) | ✅ | 36 passed |
| 组合优化 (optimization/) | ✅ | 通过 |
| 归因分析 (attribution/) | ⚠️ | 通过但有类型错误 |
| 可视化 (viz/) | ✅ | 通过 |
| Hooks (hooks/) | ❌ | 不可用 |
| 数据提供商 (data/) | ✅ | 通过 |
| 报告 (report/) | ✅ | 通过 |
| 插件系统 (plugin/) | ✅ | 通过 |
